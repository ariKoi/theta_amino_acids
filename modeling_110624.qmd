---
title: "Modeling - Exploratory Data Analysis - Amino Acid Reference Intervals"
format: 
  html:
    page-layout: full
    fig-width: 7
    fig-height: 5
    toc: true
    toc_float: true 
    toc-title: 'Amino Acids'
    number-sections: true
    number-depth: 1 
    df-print: paged
editor: visual
date: now
execute: 
  keep-md: false
  comment: NA
  message: false
  warning: false
  echo: false
  eval: true
  cache: true
  cache.lazy: true
  dpi: 300
  tidy: styler
editor_options: 
  chunk_output_type: console
mainfont: Helvetica-Oblique
monofont: FiraCode-Regular
fontsize: 15px
---

```{r}
load("/Users/aristidiskoitsanos/Desktop/ari/metabolomics/.RData")     
```

```{r}
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue")  
```

```{r}
library(tidyverse)
library(rms)
library(referenceIntervals)
library(extremevalues)
library(gt) # masked from ‘package:Hmisc’: html
library(kableExtra) # masked from ‘package:dplyr’: group_rows
```

Data source: [Ref ranges - AAU file](https://docs.google.com/spreadsheets/d/1I5IUbS86slfxIObDiZYoIhut9WrKXKpE/edit?usp=drive_link&ouid=116755605884143618266&rtpof=true&sd=true)

```{r}
Ref_ranges_AAU_2 |> mutate(across(where(is.double), ~ round(., 2)))
# skimr::skim(Ref_ranges_AAU)
```

See the file [data_desc_040624](https://drive.google.com/file/d/1CEJBCJwiNr1KfhRK-2qHiGLcdepH1fe6/view?usp=drive_link) for the data processing steps that led to the above data and for a more detailed data description i.e. missing values per variable, typical values per variable etc.

# Glycine

## Model - 1st Pass

To begin with, a test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation.

```{r}
#| label: fig-Glycine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Glycine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datGlycine, p = 2))
```

Non-linearity is evident in covariates `sex`, `aerobics_activity`, `age` (smaller $\rho^2$) and `chronic_disease_v3` (smaller $\rho^2$ with opposite sign).

From the [data processing and description file](https://drive.google.com/file/d/1CEJBCJwiNr1KfhRK-2qHiGLcdepH1fe6/view?usp=drive_link) implemented previously, `aerobics_activity` does not have many distinct values, has a low Info metric i.e. it does not meet criteria for a continuous variable. In addition due to the many zeroes it's distribution is split in half (this hints to a subgroup analysis that will be executed later). As such using a polynomial term or a spline function in order to model its non-linear association with the amino acid concentration would not be appropriate. `Age` does not have continuity issues, however its adjusted $\rho^2$ value as seen in the above Spearman $\rho^2$ plots is not high enough to justify a spline approach. Hence to capture non-linearities only interactions amongst these 4 variables will be considered in the model. Specifically, the model formula will contain the following terms or associations:

log(Glycine) \~ sex + age + sex:age + bmi + chronic_disease_v3 + age:chronic_disease_v3 + supplements_flag + log(aerobics_activity+1) + log(resistance_activity+1) + age:log(aerobics_activity+1) + chronic_disease_v3:log(aerobics_activity+1)

Where the `:` symbol denotes the interaction between two variables. Once the model is built and the coefficients are estimated, the model formula can be seen below.

```{r}
noquote(reg_f_Glycine)
```

The model's reference values can be seen below in the row named `Adjust to`.

```{r}
options(width = 164)
dd  
```

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken.

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection.

```{r}
#| label: fig-Glycine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

# Not used due to mismatch in the way that the theoretical quantiles are calculated between qqnorm and the function based on the extremevalues package (whose result is used below)
# qqnorm(resid_Glycine_mod, xlab = "Theoretical Quantiles (Predicted)", ylab = "Sample Quantiles (Observed)")   # linearity indicates normality
# qqline(as.numeric(resid_Glycine_mod), probs = c(0.025, 0.975)) # could not match it with the fig-Glycine-outliers below, so I leave it out.  

thematic::thematic_off()      
DescTools::Desc(resid_Glycine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Glycine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution.

@fig-Glycine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates perfect fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs).

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot).

```{r}
#| label: fig-Glycine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glycine_mod$outliersPlot
```

```{r}
gt(out_resid_Glycine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Glycine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Glycine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Glycine
    )
  )
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step.

Model formula:

```{r}
noquote(reg_f_Glycine_refit)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
dd_refit  
```

### Residuals

```{r}
#| label: fig-Glycine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glycine_mod_refit$outliersPlot
```

```{r}
#| label: fig-Glycine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Glycine_mod_refit), resid_Glycine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Glycine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Glycine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Glycine_mod_refit 
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Glycine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.00</td>
<td style='padding-left:4ex; text-align: right;'> 53</td>
<td style='padding-left:4ex; text-align: right;'> 19.00</td>
<td style='padding-left:4ex; text-align: right;'>-0.21970</td>
<td style='padding-left:4ex; text-align: right;'>0.15080</td>
<td style='padding-left:4ex; text-align: right;'>-0.51730</td>
<td style='padding-left:4ex; text-align: right;'> 0.07784</td>
</tr>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.75</td>
<td style='padding-left:4ex; text-align: right;'> 29</td>
<td style='padding-left:4ex; text-align: right;'>  6.25</td>
<td style='padding-left:4ex; text-align: right;'> 0.01866</td>
<td style='padding-left:4ex; text-align: right;'>0.06005</td>
<td style='padding-left:4ex; text-align: right;'>-0.09983</td>
<td style='padding-left:4ex; text-align: right;'> 0.13720</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'> 60</td>
<td style='padding-left:4ex; text-align: right;'> 60.00</td>
<td style='padding-left:4ex; text-align: right;'>-0.02294</td>
<td style='padding-left:4ex; text-align: right;'>0.11190</td>
<td style='padding-left:4ex; text-align: right;'>-0.24370</td>
<td style='padding-left:4ex; text-align: right;'> 0.19790</td>
</tr>
<tr>
<td style='text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'>540</td>
<td style='padding-left:4ex; text-align: right;'>540.00</td>
<td style='padding-left:4ex; text-align: right;'> 0.09145</td>
<td style='padding-left:4ex; text-align: right;'>0.14610</td>
<td style='padding-left:4ex; text-align: right;'>-0.19690</td>
<td style='padding-left:4ex; text-align: right;'> 0.37980</td>
</tr>
<tr>
<td style='text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.56930</td>
<td style='padding-left:4ex; text-align: right;'>0.09645</td>
<td style='padding-left:4ex; text-align: right;'>-0.75960</td>
<td style='padding-left:4ex; text-align: right;'>-0.37900</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.26820</td>
<td style='padding-left:4ex; text-align: right;'>0.18750</td>
<td style='padding-left:4ex; text-align: right;'>-0.10190</td>
<td style='padding-left:4ex; text-align: right;'> 0.63820</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  3</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.22780</td>
<td style='padding-left:4ex; text-align: right;'>0.18690</td>
<td style='padding-left:4ex; text-align: right;'>-0.14090</td>
<td style='padding-left:4ex; text-align: right;'> 0.59660</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  4</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.13210</td>
<td style='padding-left:4ex; text-align: right;'>0.37310</td>
<td style='padding-left:4ex; text-align: right;'>-0.60420</td>
<td style='padding-left:4ex; text-align: right;'> 0.86830</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  5</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.29510</td>
<td style='padding-left:4ex; text-align: right;'>0.41640</td>
<td style='padding-left:4ex; text-align: right;'>-0.52650</td>
<td style='padding-left:4ex; text-align: right;'> 1.11700</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  6</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.33630</td>
<td style='padding-left:4ex; text-align: right;'>0.30880</td>
<td style='padding-left:4ex; text-align: right;'>-0.27310</td>
<td style='padding-left:4ex; text-align: right;'> 0.94570</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  7</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.46140</td>
<td style='padding-left:4ex; text-align: right;'>0.37620</td>
<td style='padding-left:4ex; text-align: right;'>-0.28100</td>
<td style='padding-left:4ex; text-align: right;'> 1.20400</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  8</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 1.12100</td>
<td style='padding-left:4ex; text-align: right;'>0.67810</td>
<td style='padding-left:4ex; text-align: right;'>-0.21700</td>
<td style='padding-left:4ex; text-align: right;'> 2.45900</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>supplements_flag --- Yes:No</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>  2</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.05910</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.10370</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.26380</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.14560</td>
</tr>
</tbody>
</table>


```{r}
#| label: fig-Glycine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Glycine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Glycine reference value of ", round(dd_refit$limits["Glycine"][2,]), " μmol/g (median)"), nb = 14)
```

### Partial Dependence Plots

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots
#| fig-cap: "" 
#| fig-width: 8  

# ggplot(p_Glycine_mod_refit, rdata = datGlycine_refit, ylab = "Glycine μmol/g") # weird scale

# p_Glycine_mod_refit |> as_tibble() |> count(.predictor.)
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "age") |> 
#   ggplot(aes(age, yhat)) + geom_smooth()
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "bmi") |> 
#   ggplot(aes(bmi, yhat)) + geom_smooth()
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "aerobics_activity") |> 
#   ggplot(aes(aerobics_activity, yhat)) + geom_smooth(se = FALSE)
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "chronic_disease_v3") |> 
#   ggplot(aes(chronic_disease_v3, yhat)) + geom_point()

thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, sex, fun = exp))
ggplot(Predict(Glycine_mod_refit, age, fun = exp))
ggplot(Predict(Glycine_mod_refit, bmi, fun = exp))
```

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots2
#| fig-cap: "" 
#| fig-width: 8
#| fig-height: 9 

thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, chronic_disease_v3, fun = exp))
```

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots3
#| fig-cap: "" 
#| fig-width: 8 

thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, supplements_flag, fun = exp))
ggplot(Predict(Glycine_mod_refit, aerobics_activity, fun = exp))
ggplot(Predict(Glycine_mod_refit, resistance_activity, fun = exp))
```

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots4
#| fig-cap: "" 
#| fig-width: 10
 
thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, age, sex, fun = exp))
# ggplot(Predict(Glycine_mod_refit, age, chronic_disease_v3, fun = exp)) # 
ggplot(Predict(Glycine_mod_refit, age, supplements_flag, fun = exp))
ggplot(Predict(Glycine_mod_refit, bmi, sex, fun = exp))
# ggplot(Predict(Glycine_mod_refit, bmi, chronic_disease_v3, fun = exp)) # very large upper CI for a case associated with the pain chronic_disease_v3 value, which has only 7 observations in the data; see: 
# p_Glycine_mod_refit |> as_tibble() |> filter(upper > 5000) |> View()
ggplot(Predict(Glycine_mod_refit, bmi, supplements_flag, fun = exp))

# in fig-cap you can put a vector with info i.e. c("plot1","plot2","plot3")
```

## Model - 3rd Pass

The 2nd pass model uses too many degrees of freedom in relation to the size of the data. This can be see by conducting a validation and calibration analysis. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

-   Estimate model performance in the original sample of size n

-   Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample

-   Apply the model obtained in the bootstrap sample to the original sample

-   Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting)

-   Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure

-   Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate

```{r, eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Glycine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.27</td>
<td style='padding-left:3ex; text-align: center;'>0.36</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.22</td>
<td style='padding-left:3ex; text-align: center;'>0.05</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.3</td>
<td style='padding-left:3ex; text-align: center;'>0.4</td>
<td style='padding-left:3ex; text-align: center;'>-0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.44</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.41</td>
<td style='padding-left:3ex; text-align: center;'>0.46</td>
<td style='padding-left:3ex; text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>1.99</td>
<td style='padding-left:3ex; text-align: center;'>-1.99</td>
<td style='padding-left:3ex; text-align: center;'>1.99</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.69</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.31</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.69</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>78</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

From this table it can be seen that the optimism statistic which indicates the extent of model overfitting, for a variety of performance metrics has values that are large. Thus overfitting is present in the model.

By calibrating the predicted values from the model to the observed ones, we also notice a good amount of deviation from the diagonal line after correcting for this overfitting or bias.

```{r}
#| label: fig-Glycine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Glycine_mod_refit_cal)
```

The 2nd pass model also includes the chronic_disease_v3 variable which contains categories with low frequencies in the data. As a result the effect size estimate is accompanied by a very large confidence interval. This renders the estimate as non-trustworthy.

From these results and also the variable importance plot seen previously as well as the analysis of variance results, it looks like the variables, sex, age and aerobics_activity can be kept in a new model with less degree of freedom spending i.e. less overfitting the data.

# Alanine

# Valine

# Cysteine

From: https://www.fharrell.com/post/modplan/

"Regarding the choice of statistical model, we will use ordinary multiple regression for truly continuous responses, and for outcome scales that are not truly continuous or that have heavy ties in some of their values, the proportional odds ordinal logistic model. Particular strategies and assumption checking procedures for these models are given in Frank E. Harrell i.e. rms book"

Cysteine is a case with i.e. heavy ties in some of their values i.e. more than a third of its values are zero, hence use the proportional odds ordinal logistic model for this amino acid.

# Taurine

# Isoleucine

# Leucine

# Glutamine

# Glutamate

# Methionine

# Arginine

# Overlapping outlier IDs {.unnumbered}
