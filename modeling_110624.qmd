---
title: "Modeling - Exploratory Data Analysis - Amino Acid Reference Intervals"
format: 
  html:
    page-layout: full
    fig-width: 7
    fig-height: 5
    toc: true
    toc_float: true 
    toc-title: 'Amino Acids'
    number-sections: true
    number-depth: 1 
    df-print: paged
editor: visual
date: now
execute: 
  keep-md: false
  comment: NA
  message: false
  warning: false
  echo: false
  eval: true
  cache: true
  cache.lazy: true
  dpi: 300
  tidy: styler
editor_options: 
  chunk_output_type: console
mainfont: Helvetica-Oblique
monofont: FiraCode-Regular
fontsize: 15px
---

```{r}
load("/Users/aristidiskoitsanos/Desktop/ari/metabolomics/.RData")         
# source of object and function definitions are in file:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/biomic_aminoAcids_1.Rmd
```

```{r}
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue")  
```

```{r}
library(tidyverse)
library(rms) # maskings
library(referenceIntervals)
library(extremevalues)
library(gt) # masked from ‘package:Hmisc’: html
library(kableExtra) # masked from ‘package:dplyr’: group_rows      
```

Data source: [Ref ranges - AAU file](https://docs.google.com/spreadsheets/d/1I5IUbS86slfxIObDiZYoIhut9WrKXKpE/edit?usp=drive_link&ouid=116755605884143618266&rtpof=true&sd=true)

```{r}
Ref_ranges_AAU_2 |> mutate(across(where(is.double), ~ round(., 2)))
# skimr::skim(Ref_ranges_AAU)
```

See the file [data_desc_040624](https://drive.google.com/file/d/1CEJBCJwiNr1KfhRK-2qHiGLcdepH1fe6/view?usp=drive_link) for the data processing steps that led to the above data and for a more detailed data description i.e. missing values per variable, typical values per variable etc. 

# Glycine

## Model - 1st Pass

To begin with, a test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Glycine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Glycine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datGlycine, p = 2))
```

Non-linearity is evident in covariates `sex`, `aerobics_activity`, `age` (smaller $\rho^2$) and `chronic_disease_v3` (smaller $\rho^2$ with opposite sign).

From the [data processing and description file](https://drive.google.com/file/d/1CEJBCJwiNr1KfhRK-2qHiGLcdepH1fe6/view?usp=drive_link) implemented previously, `aerobics_activity` does not have many distinct values, has a low Info metric i.e. it does not meet criteria for a continuous variable. In addition due to the many zeroes it's distribution is split in half (this hints to a subgroup analysis that will be executed later). As such using a polynomial term or a spline function in order to model its non-linear association with the amino acid concentration would not be appropriate. 
`Age` does not have continuity issues, however its adjusted $\rho^2$ value as seen in the above Spearman $\rho^2$ plots is not high enough to justify a spline approach. 
Hence to capture non-linearities only interactions amongst these 4 variables will be considered in the model. Specifically, the model formula will contain the following terms or associations:

`log(Glycine) ~ sex + age + sex:age + bmi + chronic_disease_v3 + age:chronic_disease_v3 + supplements_flag + log(aerobics_activity+1) + log(resistance_activity+1) + age:log(aerobics_activity+1) + chronic_disease_v3:log(aerobics_activity+1)`

Where the `:` symbol denotes the interaction between two variables. Once the model is built and the coefficients are estimated, the model formula can be seen below.

```{r}
noquote(reg_f_Glycine)
```

The model's reference values can be seen below in the row named `Adjust to`.

```{r}
options(width = 164)
dd  
```

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Glycine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

# Not used due to mismatch in the way that the theoretical quantiles are calculated between qqnorm and the function based on the extremevalues package (whose result is used below)
# qqnorm(resid_Glycine_mod, xlab = "Theoretical Quantiles (Predicted)", ylab = "Sample Quantiles (Observed)")   # linearity indicates normality
# qqline(as.numeric(resid_Glycine_mod), probs = c(0.025, 0.975)) # could not match it with the fig-Glycine-outliers below, so I leave it out.  

thematic::thematic_off()      
DescTools::Desc(resid_Glycine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Glycine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Glycine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates perfect fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Glycine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glycine_mod$outliersPlot  
```

```{r}
gt(out_resid_Glycine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Glycine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Glycine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Glycine
    )
  )  
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step. 

Model formula: 

```{r}
noquote(reg_f_Glycine_refit)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
dd_refit  
```

### Residuals

```{r}
#| label: fig-Glycine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glycine_mod_refit$outliersPlot  
```

```{r}
#| label: fig-Glycine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Glycine_mod_refit), resid_Glycine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Glycine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Glycine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Glycine_mod_refit 
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Glycine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.00</td>
<td style='padding-left:4ex; text-align: right;'> 53</td>
<td style='padding-left:4ex; text-align: right;'> 19.00</td>
<td style='padding-left:4ex; text-align: right;'>-0.21970</td>
<td style='padding-left:4ex; text-align: right;'>0.15080</td>
<td style='padding-left:4ex; text-align: right;'>-0.51730</td>
<td style='padding-left:4ex; text-align: right;'> 0.07784</td>
</tr>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.75</td>
<td style='padding-left:4ex; text-align: right;'> 29</td>
<td style='padding-left:4ex; text-align: right;'>  6.25</td>
<td style='padding-left:4ex; text-align: right;'> 0.01866</td>
<td style='padding-left:4ex; text-align: right;'>0.06005</td>
<td style='padding-left:4ex; text-align: right;'>-0.09983</td>
<td style='padding-left:4ex; text-align: right;'> 0.13720</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'> 60</td>
<td style='padding-left:4ex; text-align: right;'> 60.00</td>
<td style='padding-left:4ex; text-align: right;'>-0.02294</td>
<td style='padding-left:4ex; text-align: right;'>0.11190</td>
<td style='padding-left:4ex; text-align: right;'>-0.24370</td>
<td style='padding-left:4ex; text-align: right;'> 0.19790</td>
</tr>
<tr>
<td style='text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'>540</td>
<td style='padding-left:4ex; text-align: right;'>540.00</td>
<td style='padding-left:4ex; text-align: right;'> 0.09145</td>
<td style='padding-left:4ex; text-align: right;'>0.14610</td>
<td style='padding-left:4ex; text-align: right;'>-0.19690</td>
<td style='padding-left:4ex; text-align: right;'> 0.37980</td>
</tr>
<tr>
<td style='text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.56930</td>
<td style='padding-left:4ex; text-align: right;'>0.09645</td>
<td style='padding-left:4ex; text-align: right;'>-0.75960</td>
<td style='padding-left:4ex; text-align: right;'>-0.37900</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.26820</td>
<td style='padding-left:4ex; text-align: right;'>0.18750</td>
<td style='padding-left:4ex; text-align: right;'>-0.10190</td>
<td style='padding-left:4ex; text-align: right;'> 0.63820</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  3</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.22780</td>
<td style='padding-left:4ex; text-align: right;'>0.18690</td>
<td style='padding-left:4ex; text-align: right;'>-0.14090</td>
<td style='padding-left:4ex; text-align: right;'> 0.59660</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  4</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.13210</td>
<td style='padding-left:4ex; text-align: right;'>0.37310</td>
<td style='padding-left:4ex; text-align: right;'>-0.60420</td>
<td style='padding-left:4ex; text-align: right;'> 0.86830</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  5</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.29510</td>
<td style='padding-left:4ex; text-align: right;'>0.41640</td>
<td style='padding-left:4ex; text-align: right;'>-0.52650</td>
<td style='padding-left:4ex; text-align: right;'> 1.11700</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  6</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.33630</td>
<td style='padding-left:4ex; text-align: right;'>0.30880</td>
<td style='padding-left:4ex; text-align: right;'>-0.27310</td>
<td style='padding-left:4ex; text-align: right;'> 0.94570</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  7</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.46140</td>
<td style='padding-left:4ex; text-align: right;'>0.37620</td>
<td style='padding-left:4ex; text-align: right;'>-0.28100</td>
<td style='padding-left:4ex; text-align: right;'> 1.20400</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  8</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 1.12100</td>
<td style='padding-left:4ex; text-align: right;'>0.67810</td>
<td style='padding-left:4ex; text-align: right;'>-0.21700</td>
<td style='padding-left:4ex; text-align: right;'> 2.45900</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>supplements_flag --- Yes:No</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>  2</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.05910</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.10370</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.26380</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.14560</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Glycine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Glycine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Glycine reference value of ", round(dd_refit$limits["Glycine"][2,]), " μmol/g (median)"), nb = 14)
```

### Partial Dependence Plots 

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots
#| fig-cap: "" 
#| fig-width: 8  

# ggplot(p_Glycine_mod_refit, rdata = datGlycine_refit, ylab = "Glycine μmol/g") # weird scale

# p_Glycine_mod_refit |> as_tibble() |> count(.predictor.)
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "age") |> 
#   ggplot(aes(age, yhat)) + geom_smooth()
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "bmi") |> 
#   ggplot(aes(bmi, yhat)) + geom_smooth()
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "aerobics_activity") |> 
#   ggplot(aes(aerobics_activity, yhat)) + geom_smooth(se = FALSE)
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "chronic_disease_v3") |> 
#   ggplot(aes(chronic_disease_v3, yhat)) + geom_point()

thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, sex, fun = exp))
ggplot(Predict(Glycine_mod_refit, age, fun = exp))
ggplot(Predict(Glycine_mod_refit, bmi, fun = exp))
```

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots2
#| fig-cap: "" 
#| fig-width: 8
#| fig-height: 9 

thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, chronic_disease_v3, fun = exp))
```

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots3
#| fig-cap: "" 
#| fig-width: 8 

thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, supplements_flag, fun = exp))
ggplot(Predict(Glycine_mod_refit, aerobics_activity, fun = exp))
ggplot(Predict(Glycine_mod_refit, resistance_activity, fun = exp))
```

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots4
#| fig-cap: "" 
#| fig-width: 10
 
thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, age, sex, fun = exp))
# ggplot(Predict(Glycine_mod_refit, age, chronic_disease_v3, fun = exp)) # 
ggplot(Predict(Glycine_mod_refit, age, supplements_flag, fun = exp))
ggplot(Predict(Glycine_mod_refit, bmi, sex, fun = exp))
# ggplot(Predict(Glycine_mod_refit, bmi, chronic_disease_v3, fun = exp)) # very large upper CI for a case associated with the pain chronic_disease_v3 value, which has only 7 observations in the data; see: 
# p_Glycine_mod_refit |> as_tibble() |> filter(upper > 5000) |> View()
ggplot(Predict(Glycine_mod_refit, bmi, supplements_flag, fun = exp))

# in fig-cap you can put a vector with info i.e. c("plot1","plot2","plot3")
```

## Additional Data Collection & Sample Size Suggestions

The data contains responses from 300 individuals, however the model uses **209** complete cases i.e. the rest contain missing values at various covariates and are thus excluded from modeling (at the moment no imputation technique is used as it is not thought that covariates can predict each other well). The 2nd pass model is built upon most of the covariates and data, and utilizes 29 degrees of freedom. As is mentioned below for the 3rd pass model development, these many degrees of freedom are too many for the current sample size, and as a result the 2nd pass model overfits the data. In order to use and obtain a trustworthy result for the 2nd pass model, the sample size should be about **435** individuals. Given that new data will also contain responses with missing values, the suggestion would be to collect in total about **550** responses or an additional **250** responses.   

## Model - 3rd Pass

The 2nd pass model uses too many degrees of freedom in relation to the size of the data. This can be see by conducting a validation and calibration analysis. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r, eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Glycine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.27</td>
<td style='padding-left:3ex; text-align: center;'>0.36</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.22</td>
<td style='padding-left:3ex; text-align: center;'>0.05</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.3</td>
<td style='padding-left:3ex; text-align: center;'>0.4</td>
<td style='padding-left:3ex; text-align: center;'>-0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.44</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.41</td>
<td style='padding-left:3ex; text-align: center;'>0.46</td>
<td style='padding-left:3ex; text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>1.99</td>
<td style='padding-left:3ex; text-align: center;'>-1.99</td>
<td style='padding-left:3ex; text-align: center;'>1.99</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.69</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.31</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.69</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>78</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">
 
From this table it can be seen that the optimism statistic which indicates the extent of model overfitting, for a variety of performance metrics has values that are large. Thus overfitting is present in the model. 

By calibrating the predicted values from the model to the observed ones, we also notice a good amount of deviation from the diagonal line after correcting for this overfitting or bias. 

```{r}
#| label: fig-Glycine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Glycine_mod_refit_cal)
```

The 2nd pass model also includes the chronic_disease_v3 variable which contains categories with low frequencies in the data. As a result the effect size estimate is accompanied by a very large confidence interval. This renders the estimate as non-trustworthy.  

From these results and also the variable importance plot seen previously as well as the analysis of variance results, it looks like the variables, sex, age and aerobics_activity can be kept in a new model with less degree of freedom spending i.e. less overfitting the data. 

Hence the model is refitted to the data with these three covariates and interactions between sex & age and between age & aerobics_activity. 

The model formula is: 

```{r}
noquote(reg_f_Glycine_refit2)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
dd_refit  
```

### Residuals

```{r}
#| label: fig-Glycine-refit2-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers. Here the algorithm reports outliers due to its parameterization, however these are weak outliers since their deviation from the straight line is not large." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glycine_mod_refit2$outliersPlot  
```

```{r}
#| label: fig-Glycine-refit2-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Glycine_mod_refit2), resid_Glycine_mod_refit2, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Glycine-refit2-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Glycine_mod_refit2), what = "proportion R2", main = "", sort = "ascending", margin = "") 
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Glycine_mod_refit2 
# eval=FALSE after html copy-pasting below
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Glycine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34</td>
<td style='padding-left:4ex; text-align: right;'>53</td>
<td style='padding-left:4ex; text-align: right;'>19</td>
<td style='padding-left:4ex; text-align: right;'>-0.1065</td>
<td style='padding-left:4ex; text-align: right;'>0.08776</td>
<td style='padding-left:4ex; text-align: right;'>-0.2794</td>
<td style='padding-left:4ex; text-align: right;'> 0.066340</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0</td>
<td style='padding-left:4ex; text-align: right;'>60</td>
<td style='padding-left:4ex; text-align: right;'>60</td>
<td style='padding-left:4ex; text-align: right;'>-0.1400</td>
<td style='padding-left:4ex; text-align: right;'>0.07170</td>
<td style='padding-left:4ex; text-align: right;'>-0.2812</td>
<td style='padding-left:4ex; text-align: right;'> 0.001298</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 2</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.5174</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.08392</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.6827</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.352000</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Glycine-refit2-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Glycine_mod_refit2, digits = 1, log = TRUE, main = paste0("% increase/decrease on Glycine reference value of ", round(dd_refit$limits["Glycine"][2,]), " μmol/g (median)"), nb = 3)
```

### Partial Dependence Plots

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot1
#| fig-cap: "Effect of sex. Female subjects seem to have higher levels of Glycine concentration." 
#| fig-width: 8  

ggplot(Predict(Glycine_mod_refit2, sex, fun = exp))
```

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot2
#| fig-cap: "Effect of age. Older subjects seem to have lower levels of Glycine concentration."
#| fig-width: 8 

ggplot(Predict(Glycine_mod_refit2, age, fun = exp))
```

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot3
#| fig-cap: "Effect of aerobics_activity. Aerobics seem to reduce the concentration of Glycine but at a relatively slow pace as the exercise duration increases." 
#| fig-width: 8 

ggplot(Predict(Glycine_mod_refit2, aerobics_activity, fun = exp))
```

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot4
#| fig-cap: "Interaction between sex and age. As age increases the concentration of Glycine between males and females seems to converge to the same value."  
#| fig-width: 8 
ggplot(Predict(Glycine_mod_refit2, age, sex, fun = exp))
```

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot5
#| fig-cap: "Interaction between sex and aerobics_activity. Parallel lines denote no interaction." 
#| fig-width: 8 

ggplot(Predict(Glycine_mod_refit2, aerobics_activity, sex, fun = exp))
```

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot6
#| fig-cap: "Simultaneous effects of age and aerobics_activity. Younger/Older subjects with larger aerobic exercise durations seem to have higher/lower concentrations of Glycine. Older subjects who exercise less seem to have higher concentrations of Glycine when compared to older subjects who exercise more."
#| fig-width: 8  
  
# pred_intx is defined in workspace
bplot(pred_intx, yhat ~ age + aerobics_activity, lfun = lattice::wireframe, zlab = "Glycine\n",  screen=list(z=-30, x=-75), ylabrot = 45, cex.lab = 0.55, cex.adj = 0.6)                      
```

### Validation & Calibration 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Glycine_mod_refit2_val, digits = 2, caption = "3rd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
3rd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.18</td>
<td style='padding-left:3ex; text-align: center;'>0.19</td>
<td style='padding-left:3ex; text-align: center;'>0.16</td>
<td style='padding-left:3ex; text-align: center;'>0.03</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.38</td>
<td style='padding-left:3ex; text-align: center;'>0.37</td>
<td style='padding-left:3ex; text-align: center;'>0.39</td>
<td style='padding-left:3ex; text-align: center;'>-0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.4</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.31</td>
<td style='padding-left:3ex; text-align: center;'>0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.31</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.32</td>
<td style='padding-left:3ex; text-align: center;'>-0.32</td>
<td style='padding-left:3ex; text-align: center;'>0.32</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.95</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.05</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.95</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

We note also that the successful number of resamples is 300 (i.e. the number of bootstrap samples that we have chosen to perform the validation). In contrast, the 2nd pass model did not use all of the 300 resamples due to divergence or singularity issues which occurred in 222 samples, and thus left only 78 resamples to use for the validation. These divergence issues were due to reasons such as missing values, categories of the chronic_disease_v3 variable with a low frequency and the complexity of the model.  
In addition this 3rd pass model has used 243 individuals instead of 209 that were used by the 2nd pass model i.e. the smaller number of covariates used in the 3rd pass model have fewer missing values. 

```{r}
#| label: fig-Glycine-refit2-cal
#| fig-cap: "Calibration plot for 3rd pass model. Deviation from the diagonal line after correcting for overfitting or bias. It can be seen that deviations have been reduced compared to the 2nd pass model." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Glycine_mod_refit2_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 3rd pass model only sex, age and aerobics_activity make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Glycine_mod_refit2, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, sex, age, aerobics_activity), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))
# |> relocate(aerobics_activity, .before = bmi) 

dynRI
```

The RI for Glycine from Mayo Clinic Laboratories for ages above 18 years is 229 to 2989 μmol/g of creatinine.

# Alanine

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Alanine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Alanine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datAlanine, p = 2))
abline(v = c(-0.01, 0, 0.01), lty = "dashed")
```

Non-linearity is evident in covariates `sex`, `aerobics_activity`, `age` (smaller $\rho^2$ with opposite sign), `bmi` (smaller $\rho^2$ with opposite sign) and `chronic_disease_v3` ($\rho^2$ with opposite sign).

To capture non-linearities only interactions amongst these 4 variables will be considered in the model. Specifically, the model formula will contain the following terms or associations:

`log(Alanine) ~ sex + age + sex:age + bmi + chronic_disease_v3 + age:chronic_disease_v3 + supplements_flag + log(aerobics_activity+1) + log(resistance_activity+1) + age:log(aerobics_activity+1) + chronic_disease_v3:log(aerobics_activity+1) + sex:bmi + bmi:log(aerobics_activity+1) + age:bmi + bmi:chronic_disease_v3 + bmi:supplements_flag + age:supplements_flag + sex:supplements_flag + sex:log(aerobics_activity+1)`

Where the `:` symbol denotes the interaction between two variables. 

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Alanine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()      
DescTools::Desc(resid_Alanine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Alanine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Alanine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Alanine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Alanine_mod$outliersPlot  
```

```{r}
gt(out_resid_Alanine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Alanine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Alanine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Alanine
    )
  )   
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step. 

### Residuals

```{r}
#| label: fig-Alanine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed weak outliers (the strong ones detected by the 1st pass model have been removed)." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Alanine_mod_refit$outliersPlot  
```

```{r}
#| label: fig-Alanine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Alanine_mod_refit), resid_Alanine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Alanine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Alanine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 19, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Alanine_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Alanine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.25</td>
<td style='padding-left:4ex; text-align: right;'> 53.00</td>
<td style='padding-left:4ex; text-align: right;'> 18.75</td>
<td style='padding-left:4ex; text-align: right;'> 0.002985</td>
<td style='padding-left:4ex; text-align: right;'>0.1982</td>
<td style='padding-left:4ex; text-align: right;'>-0.38840</td>
<td style='padding-left:4ex; text-align: right;'> 0.3943</td>
</tr>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.90</td>
<td style='padding-left:4ex; text-align: right;'> 29.35</td>
<td style='padding-left:4ex; text-align: right;'>  6.45</td>
<td style='padding-left:4ex; text-align: right;'>-0.034680</td>
<td style='padding-left:4ex; text-align: right;'>0.1273</td>
<td style='padding-left:4ex; text-align: right;'>-0.28610</td>
<td style='padding-left:4ex; text-align: right;'> 0.2167</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'> 60.00</td>
<td style='padding-left:4ex; text-align: right;'> 60.00</td>
<td style='padding-left:4ex; text-align: right;'>-0.162800</td>
<td style='padding-left:4ex; text-align: right;'>0.1685</td>
<td style='padding-left:4ex; text-align: right;'>-0.49540</td>
<td style='padding-left:4ex; text-align: right;'> 0.1699</td>
</tr>
<tr>
<td style='text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'>540.00</td>
<td style='padding-left:4ex; text-align: right;'>540.00</td>
<td style='padding-left:4ex; text-align: right;'> 0.023450</td>
<td style='padding-left:4ex; text-align: right;'>0.1954</td>
<td style='padding-left:4ex; text-align: right;'>-0.36220</td>
<td style='padding-left:4ex; text-align: right;'> 0.4092</td>
</tr>
<tr>
<td style='text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  2.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.653700</td>
<td style='padding-left:4ex; text-align: right;'>0.1922</td>
<td style='padding-left:4ex; text-align: right;'>-1.03300</td>
<td style='padding-left:4ex; text-align: right;'>-0.2743</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  2.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.097710</td>
<td style='padding-left:4ex; text-align: right;'>0.2452</td>
<td style='padding-left:4ex; text-align: right;'>-0.58180</td>
<td style='padding-left:4ex; text-align: right;'> 0.3863</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  3.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.250300</td>
<td style='padding-left:4ex; text-align: right;'>0.2391</td>
<td style='padding-left:4ex; text-align: right;'>-0.22160</td>
<td style='padding-left:4ex; text-align: right;'> 0.7223</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  4.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.320000</td>
<td style='padding-left:4ex; text-align: right;'>0.4643</td>
<td style='padding-left:4ex; text-align: right;'>-1.23700</td>
<td style='padding-left:4ex; text-align: right;'> 0.5966</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  5.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.539600</td>
<td style='padding-left:4ex; text-align: right;'>0.5862</td>
<td style='padding-left:4ex; text-align: right;'>-0.61760</td>
<td style='padding-left:4ex; text-align: right;'> 1.6970</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  6.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.149300</td>
<td style='padding-left:4ex; text-align: right;'>0.4837</td>
<td style='padding-left:4ex; text-align: right;'>-1.10400</td>
<td style='padding-left:4ex; text-align: right;'> 0.8057</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  7.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.023430</td>
<td style='padding-left:4ex; text-align: right;'>0.6691</td>
<td style='padding-left:4ex; text-align: right;'>-1.29800</td>
<td style='padding-left:4ex; text-align: right;'> 1.3440</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  8.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 2.103000</td>
<td style='padding-left:4ex; text-align: right;'>1.0820</td>
<td style='padding-left:4ex; text-align: right;'>-0.03355</td>
<td style='padding-left:4ex; text-align: right;'> 4.2400</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>supplements_flag --- Yes:No</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>  2.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.367900</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.1704</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.03139</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.7044</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Alanine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Alanine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Alanine reference value of ", round(ddAlanine_refit$limits["Alanine"][2,]), " μmol/g (median)"), nb = 14)
```

## Model - 3rd Pass

The 2nd pass model uses too many degrees of freedom in relation to the size of the data. This can be see by conducting a validation and calibration analysis. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Alanine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.32</td>
<td style='padding-left:3ex; text-align: center;'>0.46</td>
<td style='padding-left:3ex; text-align: center;'>-0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.79</td>
<td style='padding-left:3ex; text-align: center;'>-0.47</td>
<td style='padding-left:3ex; text-align: center;'>14</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.48</td>
<td style='padding-left:3ex; text-align: center;'>0.38</td>
<td style='padding-left:3ex; text-align: center;'>0.94</td>
<td style='padding-left:3ex; text-align: center;'>-0.56</td>
<td style='padding-left:3ex; text-align: center;'>1.03</td>
<td style='padding-left:3ex; text-align: center;'>14</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.53</td>
<td style='padding-left:3ex; text-align: center;'>0.64</td>
<td style='padding-left:3ex; text-align: center;'>0.35</td>
<td style='padding-left:3ex; text-align: center;'>0.29</td>
<td style='padding-left:3ex; text-align: center;'>0.24</td>
<td style='padding-left:3ex; text-align: center;'>14</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>3.02</td>
<td style='padding-left:3ex; text-align: center;'>-3.02</td>
<td style='padding-left:3ex; text-align: center;'>3.02</td>
<td style='padding-left:3ex; text-align: center;'>14</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.5</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.5</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.5</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>14</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

From this table it can be seen that the optimism statistic which indicates the extent of model overfitting, for a variety of performance metrics has values that are large. Thus overfitting is present in the model. 

By calibrating the predicted values from the model to the observed ones, we also notice a good amount of deviation from the diagonal line (ideal model performance) after correcting for this overfitting or bias. 

```{r}
#| label: fig-Alanine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Alanine_mod_refit_cal)
```

The 2nd pass model also includes the chronic_disease_v3 variable which contains categories with low frequencies in the data. As a result the effect size estimate is accompanied by a very large confidence interval. This renders the estimate as non-trustworthy.  

From these results and also the variable importance plot seen previously as well as the analysis of variance results, it looks like the variables, sex and supplements_flag can be kept in a new model with less degree of freedom spending i.e. less overfitting the data. 

Hence the model is refitted to the data with these just 2 covariates (Note: Situation might change when more data are collected and the model is refit).

The model formula is: 

```{r}
noquote(reg_f_Alanine_refit2)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddAlanine_refit  
```

### Residuals

```{r}
#| label: fig-Alanine-refit2-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers. Here the algorithm reports outliers due to its parameterization, however these are weak outliers since their deviation from the straight line is not large." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Alanine_mod_refit2$outliersPlot  
```

```{r}
#| label: fig-Alanine-refit2-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen. Since the model covariates are binary, there are four unique predictions, one for each combination of sex and supplements_flag category." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Alanine_mod_refit2), resid_Alanine_mod_refit2, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Alanine-refit2-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Alanine_mod_refit2), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 2, nx = NA, col = "black")
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Alanine_mod_refit2 
# eval=FALSE after html copy-pasting below
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Alanine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; text-align: right;'>1</td>
<td style='padding-left:4ex; text-align: right;'>2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.5242</td>
<td style='padding-left:4ex; text-align: right;'>0.1029</td>
<td style='padding-left:4ex; text-align: right;'>-0.72690</td>
<td style='padding-left:4ex; text-align: right;'>-0.3214</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>supplements_flag --- Yes:No</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>1</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>2</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.1736</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.1061</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.03533</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.3825</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Alanine-refit2-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Alanine_mod_refit2, digits = 1, log = TRUE, main = paste0("% increase/decrease on Alanine reference value of ", round(ddAlanine_refit$limits["Alanine"][2,]), " μmol/g (median)")) # nb = 5 reduces the spacing between the CIs, looks better without it on the site
```

### Partial Dependence Plots

```{r}
#| label: fig-Alanine-refit2-var-partial-effects-plot1
#| fig-cap: "Effect of sex. Female subjects seem to have higher levels of Alanine concentration." 
#| fig-width: 8  

ggplot(Predict(Alanine_mod_refit2, sex, fun = exp))
```

```{r}
#| label: fig-Alanine-refit2-var-partial-effects-plot2
#| fig-cap: "Effect of supplement intake. Taking supplements seems to increase levels of Alanine concentration, but without strong evidence."
#| fig-width: 8 

ggplot(Predict(Alanine_mod_refit2, supplements_flag, fun = exp))
```

### Validation & Calibration 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Alanine_mod_refit2_val, digits = 2, caption = "3rd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
3rd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.11</td>
<td style='padding-left:3ex; text-align: center;'>0.11</td>
<td style='padding-left:3ex; text-align: center;'>0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.09</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.62</td>
<td style='padding-left:3ex; text-align: center;'>0.61</td>
<td style='padding-left:3ex; text-align: center;'>0.62</td>
<td style='padding-left:3ex; text-align: center;'>-0.01</td>
<td style='padding-left:3ex; text-align: center;'>0.63</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.29</td>
<td style='padding-left:3ex; text-align: center;'>0.29</td>
<td style='padding-left:3ex; text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>0.01</td>
<td style='padding-left:3ex; text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.1</td>
<td style='padding-left:3ex; text-align: center;'>-0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.1</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.98</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.02</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.98</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

We note also that the successful number of resamples is 300 (i.e. the number of bootstrap samples that we have chosen to perform the validation). In contrast, the 2nd pass model did not use all of the 300 resamples due to divergence or singularity issues which occurred in 286 samples, and thus left only 14 resamples to use for the validation. These divergence issues were due to reasons such as missing values, categories of the chronic_disease_v3 variable with a low frequency and the complexity of the model.  
In addition this 3rd pass model has used 254 individuals instead of 213 that were used by the 2nd pass model i.e. the smaller number of covariates used in the 3rd pass model have fewer missing values. 

```{r}
#| label: fig-Alanine-refit2-cal
#| fig-cap: "Calibration plot for 3rd pass model. Deviation from the diagonal line after correcting for overfitting or bias. It can be seen that deviations have been reduced compared to the 2nd pass model." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Alanine_mod_refit2_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 3rd pass model only sex and supplements_flag make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Alanine_mod_refit2, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, sex, supplements_flag), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))

dynRI
```

The RI for Alanine from Mayo Clinic Laboratories for ages above 18 years is 56 to 560 μmol/g of creatinine.

# Valine

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Valine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Valine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datValine, p = 2))
abline(v = c(-0.01/3, 0.01/3), lty = "dashed")
grid(ny = 9, nx = NA, col = "black")
```

Non-linearity is evident in covariates `sex`, `resistance_activity`, `bmi` and `chronic_disease_v3`. However their $\rho^2$ values are very small, hence non-linearity strength is very low.

To capture non-linearities only interactions amongst these 4 variables are considered in the model. Specifically, the model formula contains the following terms or associations:

log(Valine) ~ sex + age + bmi + chronic_disease_v3 + supplements_flag + log(aerobics_activity+1) + log(resistance_activity+1) + sex:bmi + sex:log(resistance_activity+1) + log(resistance_activity+1):chronic_disease_v3 + log(resistance_activity+1):bmi

Where the `:` symbol denotes the interaction between two variables. 

Even though this model uses information from all meta data covariates, and is in addition quite complex due to the modeled interactions, the global significance of the model is very small i.e. global p-value based on the Likelihood Ratio Test is 0.62, well above the 0.05 typical threshold. 
As a result, and after different combinations of the covariates were tested in the model, the best model was the one including only bmi and resistance_activity as covariates. This model had a global regression p-value of 0.0542 (marginally significant). 
To note, this statistic is further improved with the 2nd pass model below i.e. p-value of 0.0175

Thus the 1st pass model formula is:

`log(Valine) ~ bmi + log(resistance_activity+1)`

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Valine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()       
DescTools::Desc(resid_Valine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Valine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Valine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Valine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Valine_mod$outliersPlot   
```

```{r}
gt(out_resid_Valine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Valine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Valine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Valine
    )
  )    
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step. 

### Residuals

```{r}
#| label: fig-Valine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed weak outliers (the strong ones detected by the 1st pass model have been removed)." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Valine_mod_refit$outliersPlot   
```

```{r}
#| label: fig-Valine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Valine_mod_refit), resid_Valine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Valine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Valine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 2, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Valine_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Valine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.8</td>
<td style='padding-left:4ex; text-align: right;'> 29.1</td>
<td style='padding-left:4ex; text-align: right;'>  6.3</td>
<td style='padding-left:4ex; text-align: right;'> 0.05646</td>
<td style='padding-left:4ex; text-align: right;'>0.03123</td>
<td style='padding-left:4ex; text-align: right;'>-0.005082</td>
<td style='padding-left:4ex; text-align: right;'>0.118000</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>450.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>450.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.14610</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.07464</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.293200</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.001033</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Valine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Valine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Valine reference value of ", round(ddValine_refit$limits["Valine"][2,]), " μmol/g (median)"))
```

For Valine, there's no 3rd pass model since the 2nd pass is built on just 2 covariates and does not overfit.

The model formula is: 

```{r}
noquote(reg_f_Valine_refit)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddValine_refit  
```

### Partial Dependence Plots

```{r}
#| label: fig-Valine-refit-var-partial-effects-plot1
#| fig-cap: "Effect of bmi. Valine concentration increasing with bmi on average." 
#| fig-width: 8  

ggplot(Predict(Valine_mod_refit, bmi, fun = exp))
```

```{r}
#| label: fig-Valine-refit-var-partial-effects-plot2
#| fig-cap: "Effect of resistance training. Spending more time on resistance training seems to decrease levels of Valine concentration, but at a relatively slow pace. The effect is more prominent from no resistance training to about 4 hours per week i.e. 250/60"
#| fig-width: 8 

ggplot(Predict(Valine_mod_refit, resistance_activity, fun = exp))
```

```{r}
#| label: fig-Valine-refit-var-partial-effects-plot3
#| fig-cap: "Simultaneous effects of bmi and resistance_activity. Individuals who do not include resistance training in their fitness program have higher levels of Valine concentration, and those levels increase with the bmi."
#| fig-width: 8  
  
# pred_intx_Valine is defined in workspace
bplot(pred_intx_Valine, yhat ~ bmi + resistance_activity, lfun = lattice::wireframe, zlab = "Valine\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6)
```

### Validation & Calibration 

To assess model performance, a validation and calibration analysis is conducted below as with other amino acids. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Valine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.01</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>0.14</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.09</td>
<td style='padding-left:3ex; text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.01</td>
<td style='padding-left:3ex; text-align: center;'>0.07</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.17</td>
<td style='padding-left:3ex; text-align: center;'>-0.17</td>
<td style='padding-left:3ex; text-align: center;'>0.17</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.95</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.05</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.95</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

```{r}
#| label: fig-Valine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias. The larger deviations occur to the left of the plot which means that the model has some tendency to underestimate the true Valine concentration value i.e. if the model predicts 23.33 μmol/g, then actual is 23.33*exp(mae=0.015) = 23.68 μmol/g" 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Valine_mod_refit_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 2nd pass model only bmi and resistance_activity make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Valine_mod_refit, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, bmi, resistance_activity), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))

dynRI
```

The RI for Valine from Mayo Clinic Laboratories for ages above 18 years is 11 to 88 μmol/g of creatinine.

# Cysteine

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Cysteine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Cysteine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datCysteineNoZeroes, p = 2, na.action = na.omit))
abline(v = c(-0.02/2, 0.02/2), lty = "dashed")
grid(ny = 9, nx = NA, col = "black")
```

Non-linearity evident in bmi, resistance_activity (smaller $\rho^2$ with opposite sign), chronic_disease_v3 (smaller $\rho^2$ with opposite sign). Most rho values are relatively small though with bmi being the exception 

To capture non linearities interactions amongst these 3 variables will be considered, as well as splines for bmi. Also age will be included as it has some linearity association: 

`log(Cysteine) ~ rcs(bmi, 4) + age + chronic_disease_v3 + log(resistance_activity+1) + log(resistance_activity+1):rcs(bmi, 4)`

Where the `:` symbol denotes the interaction between two variables and rcs denotes a restricted cubic spline transformation with 4 knots. 

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Cysteine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()      
DescTools::Desc(resid_Cysteine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Cysteine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Cysteine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Cysteine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Cysteine_mod$outliersPlot
```

```{r}
gt(out_resid_Cysteine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Cysteine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Cysteine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Cysteine
    )
  )
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step. 

### Residuals

```{r}
#| label: fig-Cysteine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed weak outliers (the strong ones detected by the 1st pass model have been removed)." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Cysteine_mod_refit$outliersPlot
```

```{r}
#| label: fig-Cysteine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Cysteine_mod_refit), resid_Cysteine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Cysteine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Cysteine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 5, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Cysteine_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Cysteine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>23.25</td>
<td style='padding-left:4ex; text-align: right;'>30.3</td>
<td style='padding-left:4ex; text-align: right;'> 7.05</td>
<td style='padding-left:4ex; text-align: right;'> 0.32730</td>
<td style='padding-left:4ex; text-align: right;'>0.19520</td>
<td style='padding-left:4ex; text-align: right;'>-0.058600</td>
<td style='padding-left:4ex; text-align: right;'>0.71330</td>
</tr>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>35.00</td>
<td style='padding-left:4ex; text-align: right;'>52.0</td>
<td style='padding-left:4ex; text-align: right;'>17.00</td>
<td style='padding-left:4ex; text-align: right;'> 0.11730</td>
<td style='padding-left:4ex; text-align: right;'>0.08842</td>
<td style='padding-left:4ex; text-align: right;'>-0.057530</td>
<td style='padding-left:4ex; text-align: right;'>0.29220</td>
</tr>
<tr>
<td style='text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'>42.5</td>
<td style='padding-left:4ex; text-align: right;'>42.50</td>
<td style='padding-left:4ex; text-align: right;'> 0.29170</td>
<td style='padding-left:4ex; text-align: right;'>0.14650</td>
<td style='padding-left:4ex; text-align: right;'> 0.002049</td>
<td style='padding-left:4ex; text-align: right;'>0.58130</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 2.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.07755</td>
<td style='padding-left:4ex; text-align: right;'>0.19310</td>
<td style='padding-left:4ex; text-align: right;'>-0.459400</td>
<td style='padding-left:4ex; text-align: right;'>0.30430</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 3.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.15410</td>
<td style='padding-left:4ex; text-align: right;'>0.21360</td>
<td style='padding-left:4ex; text-align: right;'>-0.268300</td>
<td style='padding-left:4ex; text-align: right;'>0.57640</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 4.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.05171</td>
<td style='padding-left:4ex; text-align: right;'>0.24080</td>
<td style='padding-left:4ex; text-align: right;'>-0.424500</td>
<td style='padding-left:4ex; text-align: right;'>0.52790</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 5.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.16380</td>
<td style='padding-left:4ex; text-align: right;'>0.30430</td>
<td style='padding-left:4ex; text-align: right;'>-0.765500</td>
<td style='padding-left:4ex; text-align: right;'>0.43800</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 6.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.12680</td>
<td style='padding-left:4ex; text-align: right;'>0.28320</td>
<td style='padding-left:4ex; text-align: right;'>-0.686700</td>
<td style='padding-left:4ex; text-align: right;'>0.43310</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 7.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.71560</td>
<td style='padding-left:4ex; text-align: right;'>0.37190</td>
<td style='padding-left:4ex; text-align: right;'>-1.451000</td>
<td style='padding-left:4ex; text-align: right;'>0.01981</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 8.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.22440</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.43780</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.641200</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>1.09000</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Cysteine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Cysteine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Cysteine reference value of ", round(ddCysteine_refit$limits["Cysteine"][2,]), " μmol/g (median)"), nb = 14)
```

## Model - 3rd Pass

The 2nd pass model uses too many degrees of freedom (df) in relation to the size of the data i.e. 10 df should be spent instead of the 16 from the model. This can be see by conducting a validation and calibration analysis. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Cysteine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>0.21</td>
<td style='padding-left:3ex; text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>0.18</td>
<td style='padding-left:3ex; text-align: center;'>-0.03</td>
<td style='padding-left:3ex; text-align: center;'>278</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.47</td>
<td style='padding-left:3ex; text-align: center;'>0.43</td>
<td style='padding-left:3ex; text-align: center;'>0.52</td>
<td style='padding-left:3ex; text-align: center;'>-0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.56</td>
<td style='padding-left:3ex; text-align: center;'>278</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.31</td>
<td style='padding-left:3ex; text-align: center;'>0.37</td>
<td style='padding-left:3ex; text-align: center;'>0.24</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.18</td>
<td style='padding-left:3ex; text-align: center;'>278</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.96</td>
<td style='padding-left:3ex; text-align: center;'>-0.96</td>
<td style='padding-left:3ex; text-align: center;'>0.96</td>
<td style='padding-left:3ex; text-align: center;'>278</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.63</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.37</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.63</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>278</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

From this table it can be seen that the optimism statistic which indicates the extent of model overfitting, for a variety of performance metrics has values that are large. Thus overfitting is present in the model. 

By calibrating the predicted values from the model to the observed ones, we also notice a good amount of deviation from the diagonal line (ideal model performance) after correcting for this overfitting or bias. 

```{r}
#| label: fig-Cysteine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Cysteine_mod_refit_cal)
```

The 2nd pass model also includes the chronic_disease_v3 variable which contains categories with low frequencies in the data. As a result the effect size estimate is accompanied by a very large confidence interval. This renders the estimate as non-trustworthy.  

From these results and also the variable importance plot seen previously as well as the analysis of variance results, it looks like the variables, bmi, age and resistance_activity can be kept in a new model with less degree of freedom spending i.e. less overfitting the data. 

Hence the model is refitted to the data with these just 3 covariates (Note: Situation might change when more data are collected and the model is refit).

The model formula is: 

```{r}
noquote(reg_f_Cysteine_refit2)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddCysteine_refit  
```

### Residuals

```{r}
#| label: fig-Cysteine-refit2-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers. Here the algorithm reports outliers due to its parameterization, however these are weak outliers since their deviation from the straight line is not large." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Cysteine_mod_refit2$outliersPlot
```

```{r}
#| label: fig-Cysteine-refit2-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen. Since the model covariates are binary, there are four unique predictions, one for each combination of sex and supplements_flag category." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Cysteine_mod_refit2), resid_Cysteine_mod_refit2, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Cysteine-refit2-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Cysteine_mod_refit2), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 4, nx = NA, col = "black")
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Cysteine_mod_refit2 
# eval=FALSE after html copy-pasting below
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Cysteine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>23.25</td>
<td style='padding-left:4ex; text-align: right;'>30.3</td>
<td style='padding-left:4ex; text-align: right;'> 7.05</td>
<td style='padding-left:4ex; text-align: right;'>0.3326</td>
<td style='padding-left:4ex; text-align: right;'>0.19120</td>
<td style='padding-left:4ex; text-align: right;'>-0.04525</td>
<td style='padding-left:4ex; text-align: right;'>0.7104</td>
</tr>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>35.00</td>
<td style='padding-left:4ex; text-align: right;'>52.0</td>
<td style='padding-left:4ex; text-align: right;'>17.00</td>
<td style='padding-left:4ex; text-align: right;'>0.1207</td>
<td style='padding-left:4ex; text-align: right;'>0.07642</td>
<td style='padding-left:4ex; text-align: right;'>-0.03035</td>
<td style='padding-left:4ex; text-align: right;'>0.2717</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>42.5</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>42.50</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.2620</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.14040</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.01559</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.5395</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Cysteine-refit2-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Cysteine_mod_refit2, digits = 1, log = TRUE, main = paste0("% increase/decrease on Cysteine reference value of ", round(ddCysteine_refit$limits["Cysteine"][2,]), " μmol/g (median)"), nb = 4) # nb = 4 reduces the spacing between the CIs, looks better without it on the site
```

### Partial Dependence Plots

```{r}
#| label: fig-Cysteine-refit2-var-partial-effects-plot1
#| fig-cap: "Nonlinear effect of bmi. Cysteine concentration levels can be seen to decrease until the age of 24 and thereafter steadily but slowly increase with increasing bmi." 
#| fig-width: 8  

ggplot(Predict(Cysteine_mod_refit2, bmi, fun = exp))
```

```{r}
#| label: fig-Cysteine-refit2-var-partial-effects-plot2
#| fig-cap: "Effect of age. Age is seen to increase the levels of Cysteine concentration."
#| fig-width: 8 

ggplot(Predict(Cysteine_mod_refit2, age, fun = exp))
```

```{r}
#| label: fig-Cysteine-refit2-var-partial-effects-plot3
#| fig-cap: "Effect of resistance_activity. Resistance training is seen to increase the levels of Cysteine concentration, especially when moving from no training at all to increasing training durations per week. The pace of increase is slow."
#| fig-width: 8 

ggplot(Predict(Cysteine_mod_refit2, resistance_activity, fun = exp))
```

```{r}
#| label: fig-Cysteine-refit2-var-partial-effects-plot4
#| fig-cap: "Simultaneous effects of bmi and resistance_activity. Cysteine concentration levels are seen to increase with the increase of bmi and the duration of resistance training, particularly beyond the bmi threshold of 35 $kg/m^2$"
#| fig-width: 8  
  
# pred_intx_Cysteine is defined in workspace
bplot(pred_intx_Cysteine, yhat ~ bmi + resistance_activity, lfun = lattice::wireframe, zlab = "Cysteine\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6)
```

### Validation & Calibration 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Cysteine_mod_refit2_val, digits = 2, caption = "3rd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
3rd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.11</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>0.05</td>
<td style='padding-left:3ex; text-align: center;'>0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.01</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.48</td>
<td style='padding-left:3ex; text-align: center;'>0.46</td>
<td style='padding-left:3ex; text-align: center;'>0.52</td>
<td style='padding-left:3ex; text-align: center;'>-0.06</td>
<td style='padding-left:3ex; text-align: center;'>0.55</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>0.31</td>
<td style='padding-left:3ex; text-align: center;'>0.23</td>
<td style='padding-left:3ex; text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.2</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.64</td>
<td style='padding-left:3ex; text-align: center;'>-0.64</td>
<td style='padding-left:3ex; text-align: center;'>0.64</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.75</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.25</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.75</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

We note also that the successful number of resamples is 300 (i.e. the number of bootstrap samples that we have chosen to perform the validation). In contrast, the 2nd pass model did not use all of the 300 resamples due to divergence or singularity issues which occurred in 22 samples, and thus left only 278 resamples to use for the validation. These divergence issues were due to reasons such as missing values, categories of the chronic_disease_v3 variable with a low frequency and the complexity of the model.  
In addition this 3rd pass model has used only 154 individuals from the current pool of 308 due the many zero or non-detection cases in the data. 

```{r}
#| label: fig-Cysteine-refit2-cal
#| fig-cap: "Calibration plot for 3rd pass model. Deviation from the diagonal line after correcting for overfitting or bias. It can be seen that deviations have been reduced compared to the 2nd pass model, especially on the right side, but not on the middle and left parts of the comparison. On the middle part there is some overestimation while on the left there is underestimation of the true values. This is perhaps due to the currently small sample size of 154 individuals upon the models have been built." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Cysteine_mod_refit2_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 3rd pass model only bmi, age and resistance_activity make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Cysteine_mod_refit2, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, bmi, age, resistance_activity), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))

dynRI
```

The RI for Cysteine from Mayo Clinic Laboratories for ages above 18 years is 12 to 98 μmol/g of creatinine.

# Taurine

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Taurine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Taurine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datTaurine, p = 2, na.action = na.omit))
abline(v = c(-0.01/2, 0.01/2), lty = "dashed")
grid(ny = 9, nx = NA, col = "black")
```

Linearity is evident in `aerobics_activity` (relevant plot not shown). 
Non-linearity is evident in covariates `age`, `resistance_activity`, `bmi` and `chronic_disease_v3`. However their $\rho^2$ values are very small, hence non-linearity strength is very low.

To capture non-linearities only interactions amongst these 5 variables are considered in the model.

After different combinations of the covariates were tested in the model, the best model was the one including only aerobics_activity as the single covariate. This model had a global regression p-value of `0.078` (marginally significant). 

Thus the 1st pass model formula is:

`log(Taurine) ~ log(aerobics_activity+1)`

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Taurine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()       
DescTools::Desc(resid_Taurine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Taurine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Taurine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Taurine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Taurine_mod$outliersPlot   
```

```{r}
gt(out_resid_Taurine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Taurine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Taurine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Taurine
    )
  )    
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step. 

Utilizing the same model formula as in the 1st pass model i.e. a model with only aerobics_activity as a covariate did not result into global regression significance. As a result a new model formula was searched with the following being the best found:

`log(Taurine) ~ rcs(age,3) + supplements_flag + rcs(age,3):supplements_flag + log(aerobics_activity+1) + supplements_flag:log(aerobics_activity+1) + sex + sex:supplements_flag`

Where `:` denotes an interaction term and `rcs` a restricted cubic spline to capture non-linear association. 
However this model, even after an extensive search using a variety of covariate combinations, still does not have global regression significance with a p-value close to `0.14`. 
Since this is currently the only option, this model is kept as the 2nd pass model (it is hoped that with more data global regression significance can be achieved). 

### Residuals & Model Refit

```{r}
#| label: fig-Taurine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are typically deemed weak outliers (the strong ones detected by the 1st pass model have been removed). An exception for the Taurine case is that there's still is a strong outlier present, which can be seen on the right side of the plot. This data point is further removed from the data and the 2nd pass model is refit again." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Taurine_mod_refit$outliersPlot   
```

As an exception to previously analysed amino acids, here there was an additional strong outlier that was removed from the data. This corresponds to the subject id `34734` as shown in the table below. 

```{r}
gt(out_resid_Taurine_mod_refit$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Taurine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Taurine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Taurine
    )
  )   
# positive error: i.e. log(3000)-log(100)
```

The 2nd pass model was then refit one more time (without id `34734`) using the same last model formula:

`log(Taurine) ~ rcs(age,3) + supplements_flag + rcs(age,3):supplements_flag + log(aerobics_activity+1) + supplements_flag:log(aerobics_activity+1) + sex + sex:supplements_flag`

This version of the model resulted in marginal globla regression significance with a p-value of `0.06` and the updated residual qq plot below.

```{r}
#| label: fig-Taurine-refit-resid2-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are typically deemed weak outliers (the strong ones detected by the 1st and 2nd pass models have been removed)." 

out_resid_Taurine_mod_refit2$outliersPlot   
```

```{r}
#| label: fig-Taurine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Taurine_mod_refit), resid_Taurine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Taurine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Taurine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 7, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Taurine_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Taurine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34</td>
<td style='padding-left:4ex; text-align: right;'>53</td>
<td style='padding-left:4ex; text-align: right;'>19</td>
<td style='padding-left:4ex; text-align: right;'> 0.08265</td>
<td style='padding-left:4ex; text-align: right;'>0.1115</td>
<td style='padding-left:4ex; text-align: right;'>-0.13700</td>
<td style='padding-left:4ex; text-align: right;'>0.30230</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0</td>
<td style='padding-left:4ex; text-align: right;'>60</td>
<td style='padding-left:4ex; text-align: right;'>60</td>
<td style='padding-left:4ex; text-align: right;'> 0.09023</td>
<td style='padding-left:4ex; text-align: right;'>0.1387</td>
<td style='padding-left:4ex; text-align: right;'>-0.18300</td>
<td style='padding-left:4ex; text-align: right;'>0.36350</td>
</tr>
<tr>
<td style='text-align: left;'>supplements_flag --- Yes:No</td>
<td style='padding-left:4ex; text-align: right;'> 1</td>
<td style='padding-left:4ex; text-align: right;'> 2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.39710</td>
<td style='padding-left:4ex; text-align: right;'>0.2221</td>
<td style='padding-left:4ex; text-align: right;'>-0.04059</td>
<td style='padding-left:4ex; text-align: right;'>0.83470</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 2</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.22530</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.1606</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.54160</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.09108</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Taurine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Taurine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Taurine reference value of ", round(ddTaurine_refit$limits["Taurine"][2,]), " μmol/g (median)"), nb = 5)
```

For Taurine, there's no 3rd pass model due to the difficulties in establishing a significant model and the fact that 10 degrees of freedom are spent by the model from an empirical max of 16. 

The model formula is: 

```{r}
noquote(reg_f_Taurine_refit)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddTaurine_refit  
```

### Partial Dependence Plots

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot1
#| fig-cap: "Effect of age. U-shaped average effect on Taurine concentration. Young and old subjects exhibit an increase in Taurine concentration with the pace of increase being stronger for older subjects." 
#| fig-width: 8  

ggplot(Predict(Taurine_mod_refit, age, fun = exp))
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot2
#| fig-cap: "Effect of aerobics training. Spending more time on aerobics training seems to increase levels of Taurine concentration, but at a relatively slow pace. The effect is more prominent from no resistance training to about 3 hours per week i.e. 180/60"
#| fig-width: 8 

ggplot(Predict(Taurine_mod_refit, aerobics_activity, fun = exp))
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot3
#| fig-cap: "Effect of supplements intake. Taking supplenents increase the Taurine concentration but the difference from non-takers is not significant."
#| fig-width: 8 

ggplot(Predict(Taurine_mod_refit, supplements_flag, fun = exp))
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot4
#| fig-cap: "Effect of sex. No difference between males and females."
#| fig-width: 8 

ggplot(Predict(Taurine_mod_refit, sex, fun = exp))
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot5
#| fig-cap: "Simultaneous effects of supplement intake and age. Individuals who are either old and do not take any supplements or who are young and do take supplements have higher levels of Taurine concentration."
#| fig-width: 8  
  
# pred_intx1_Taurine is defined in workspace
bplot(pred_intx1_Taurine, yhat ~ supplements_flag + age, lfun = lattice::wireframe, zlab = "Taurine\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6, xlabrot = -40)
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot6
#| fig-cap: "Simultaneous effects of supplement intake and sex. Males who do take supplements have higher levels of Taurine concentration."
#| fig-width: 8  
  
# pred_intx2_Taurine is defined in workspace
bplot(pred_intx2_Taurine, yhat ~ supplements_flag + sex, lfun = lattice::wireframe, zlab = "Taurine\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6, xlabrot = -40)
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot7
#| fig-cap: "Simultaneous effects of supplement intake and aerobics_activity. Individuals who do not follow an aerobic activity but take supplements tend to have higher levels of Taurine concentration."
#| fig-width: 8  
  
# pred_intx3_Taurine is defined in workspace
bplot(pred_intx3_Taurine, yhat ~ supplements_flag + aerobics_activity, lfun = lattice::wireframe, zlab = "Taurine\n",  screen=list(z=320, x=-75), cex.lab = 0.55, cex.adj = 0.6, xlabrot = -24, ylabrot = 30)
```

### Validation & Calibration 

To assess model performance, a validation and calibration analysis is conducted below as with other amino acids. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Taurine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.06</td>
<td style='padding-left:3ex; text-align: center;'>0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>-0.02</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.88</td>
<td style='padding-left:3ex; text-align: center;'>0.84</td>
<td style='padding-left:3ex; text-align: center;'>0.92</td>
<td style='padding-left:3ex; text-align: center;'>-0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.96</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.27</td>
<td style='padding-left:3ex; text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.22</td>
<td style='padding-left:3ex; text-align: center;'>0.12</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>2.28</td>
<td style='padding-left:3ex; text-align: center;'>-2.28</td>
<td style='padding-left:3ex; text-align: center;'>2.28</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.65</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.35</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.65</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

```{r}
#| label: fig-Taurine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias. The larger deviations occur to the right of the plot which means that the model has some tendency to overestimate the true Taurine concentration value i.e. if the model predicts exp(7) = 1000 μmol/g, then actual is 1000*exp(mae=-0.059) = 943 μmol/g ~ exp(6.8)" 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Taurine_mod_refit_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 2nd pass model only age, supplements_flag, aerobics_activity and sex make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Taurine_mod_refit, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> 
               select(id, sex, age, aerobics_activity, supplements_flag) |> 
               rename(aerobics = aerobics_activity, supplements = supplements_flag), by = "id") |> # shorter names so the output does not sqeeze the age name into a..
  mutate(across(where(is.double), ~ round(., 2)))

dynRI     
```

The RI for Taurine from Mayo Clinic Laboratories for ages above 18 years is 24 to 1560 μmol/g of creatinine.

# Isoleucine



# Leucine



# Glutamine



# Glutamate



# Methionine



# Arginine



# Other Section {.unnumbered}


