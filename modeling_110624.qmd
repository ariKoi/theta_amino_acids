---
title: "Modeling - Exploratory Data Analysis - Amino Acid Reference Intervals"
format: 
  html:
    page-layout: full
    fig-width: 7
    fig-height: 5
    toc: true
    toc_float: true 
    toc-title: 'Amino Acids'
    number-sections: true
    number-depth: 1 
    df-print: paged
editor: visual
date: now
execute: 
  keep-md: false
  comment: NA
  message: false
  warning: false
  echo: false
  eval: true
  cache: true
  cache.lazy: true
  dpi: 300
  tidy: styler
editor_options: 
  chunk_output_type: console
mainfont: Helvetica-Oblique
monofont: FiraCode-Regular
fontsize: 15px
---

```{r}
load("/Users/aristidiskoitsanos/Desktop/ari/metabolomics/.RData")             
# source of object and function definitions are in file:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/biomic_aminoAcids_1.Rmd
```

```{r}
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue")  
```

```{r}
library(tidyverse)
library(rms) # maskings
library(referenceIntervals)
library(extremevalues)
library(gt) # masked from ‘package:Hmisc’: html
library(kableExtra) # masked from ‘package:dplyr’: group_rows          
```

Data source: [Ref ranges - AAU file](https://docs.google.com/spreadsheets/d/1I5IUbS86slfxIObDiZYoIhut9WrKXKpE/edit?usp=drive_link&ouid=116755605884143618266&rtpof=true&sd=true)

```{r}
Ref_ranges_AAU_2 |> mutate(across(where(is.double), ~ round(., 2)))
# skimr::skim(Ref_ranges_AAU)
```

See the file [data_desc_040624](https://drive.google.com/file/d/1CEJBCJwiNr1KfhRK-2qHiGLcdepH1fe6/view?usp=drive_link) for the data processing steps that led to the above data and for a more detailed data description i.e. missing values per variable, typical values per variable etc. 

# Glycine

## Model - 1st Pass

To begin with, a test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Glycine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Glycine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datGlycine, p = 2))
```

Non-linearity is evident in covariates `sex`, `aerobics_activity`, `age` (smaller $\rho^2$) and `chronic_disease_v3` (smaller $\rho^2$ with opposite sign).

From the [data processing and description file](https://drive.google.com/file/d/1CEJBCJwiNr1KfhRK-2qHiGLcdepH1fe6/view?usp=drive_link) implemented previously, `aerobics_activity` does not have many distinct values, has a low Info metric i.e. it does not meet criteria for a continuous variable. In addition due to the many zeroes it's distribution is split in half (this hints to a subgroup analysis that will be executed later). As such using a polynomial term or a spline function in order to model its non-linear association with the amino acid concentration would not be appropriate. 
`Age` does not have continuity issues, however its adjusted $\rho^2$ value as seen in the above Spearman $\rho^2$ plots is not high enough to justify a spline approach. 
Hence to capture non-linearities only interactions amongst these 4 variables will be considered in the model. Specifically, the model formula will contain the following terms or associations:

`log(Glycine) ~ sex + age + sex:age + bmi + chronic_disease_v3 + age:chronic_disease_v3 + supplements_flag + log(aerobics_activity+1) + log(resistance_activity+1) + age:log(aerobics_activity+1) + chronic_disease_v3:log(aerobics_activity+1)`

Where the `:` symbol denotes the interaction between two variables. Once the model is built and the coefficients are estimated, the model formula can be seen below.

```{r}
noquote(reg_f_Glycine)
```

The model's reference values can be seen below in the row named `Adjust to`.

```{r}
options(width = 164)
dd  
```

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Glycine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

# Not used due to mismatch in the way that the theoretical quantiles are calculated between qqnorm and the function based on the extremevalues package (whose result is used below)
# qqnorm(resid_Glycine_mod, xlab = "Theoretical Quantiles (Predicted)", ylab = "Sample Quantiles (Observed)")   # linearity indicates normality
# qqline(as.numeric(resid_Glycine_mod), probs = c(0.025, 0.975)) # could not match it with the fig-Glycine-outliers below, so I leave it out.  

thematic::thematic_off()      
DescTools::Desc(resid_Glycine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Glycine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Glycine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates perfect fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Glycine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glycine_mod$outliersPlot  
```

```{r}
gt(out_resid_Glycine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Glycine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Glycine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Glycine
    )
  )  
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step. 

Model formula: 

```{r}
noquote(reg_f_Glycine_refit)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
dd_refit  
```

### Residuals

```{r}
#| label: fig-Glycine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glycine_mod_refit$outliersPlot  
```

```{r}
#| label: fig-Glycine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Glycine_mod_refit), resid_Glycine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Glycine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Glycine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Glycine_mod_refit 
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Glycine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.00</td>
<td style='padding-left:4ex; text-align: right;'> 53</td>
<td style='padding-left:4ex; text-align: right;'> 19.00</td>
<td style='padding-left:4ex; text-align: right;'>-0.21970</td>
<td style='padding-left:4ex; text-align: right;'>0.15080</td>
<td style='padding-left:4ex; text-align: right;'>-0.51730</td>
<td style='padding-left:4ex; text-align: right;'> 0.07784</td>
</tr>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.75</td>
<td style='padding-left:4ex; text-align: right;'> 29</td>
<td style='padding-left:4ex; text-align: right;'>  6.25</td>
<td style='padding-left:4ex; text-align: right;'> 0.01866</td>
<td style='padding-left:4ex; text-align: right;'>0.06005</td>
<td style='padding-left:4ex; text-align: right;'>-0.09983</td>
<td style='padding-left:4ex; text-align: right;'> 0.13720</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'> 60</td>
<td style='padding-left:4ex; text-align: right;'> 60.00</td>
<td style='padding-left:4ex; text-align: right;'>-0.02294</td>
<td style='padding-left:4ex; text-align: right;'>0.11190</td>
<td style='padding-left:4ex; text-align: right;'>-0.24370</td>
<td style='padding-left:4ex; text-align: right;'> 0.19790</td>
</tr>
<tr>
<td style='text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'>540</td>
<td style='padding-left:4ex; text-align: right;'>540.00</td>
<td style='padding-left:4ex; text-align: right;'> 0.09145</td>
<td style='padding-left:4ex; text-align: right;'>0.14610</td>
<td style='padding-left:4ex; text-align: right;'>-0.19690</td>
<td style='padding-left:4ex; text-align: right;'> 0.37980</td>
</tr>
<tr>
<td style='text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.56930</td>
<td style='padding-left:4ex; text-align: right;'>0.09645</td>
<td style='padding-left:4ex; text-align: right;'>-0.75960</td>
<td style='padding-left:4ex; text-align: right;'>-0.37900</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.26820</td>
<td style='padding-left:4ex; text-align: right;'>0.18750</td>
<td style='padding-left:4ex; text-align: right;'>-0.10190</td>
<td style='padding-left:4ex; text-align: right;'> 0.63820</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  3</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.22780</td>
<td style='padding-left:4ex; text-align: right;'>0.18690</td>
<td style='padding-left:4ex; text-align: right;'>-0.14090</td>
<td style='padding-left:4ex; text-align: right;'> 0.59660</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  4</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.13210</td>
<td style='padding-left:4ex; text-align: right;'>0.37310</td>
<td style='padding-left:4ex; text-align: right;'>-0.60420</td>
<td style='padding-left:4ex; text-align: right;'> 0.86830</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  5</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.29510</td>
<td style='padding-left:4ex; text-align: right;'>0.41640</td>
<td style='padding-left:4ex; text-align: right;'>-0.52650</td>
<td style='padding-left:4ex; text-align: right;'> 1.11700</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  6</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.33630</td>
<td style='padding-left:4ex; text-align: right;'>0.30880</td>
<td style='padding-left:4ex; text-align: right;'>-0.27310</td>
<td style='padding-left:4ex; text-align: right;'> 0.94570</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  7</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.46140</td>
<td style='padding-left:4ex; text-align: right;'>0.37620</td>
<td style='padding-left:4ex; text-align: right;'>-0.28100</td>
<td style='padding-left:4ex; text-align: right;'> 1.20400</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  8</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 1.12100</td>
<td style='padding-left:4ex; text-align: right;'>0.67810</td>
<td style='padding-left:4ex; text-align: right;'>-0.21700</td>
<td style='padding-left:4ex; text-align: right;'> 2.45900</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>supplements_flag --- Yes:No</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>  2</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.05910</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.10370</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.26380</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.14560</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Glycine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Glycine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Glycine reference value of ", round(dd_refit$limits["Glycine"][2,]), " μmol/g (median)"), nb = 14)
```

### Partial Dependence Plots 

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots
#| fig-cap: "" 
#| fig-width: 8  

# ggplot(p_Glycine_mod_refit, rdata = datGlycine_refit, ylab = "Glycine μmol/g") # weird scale

# p_Glycine_mod_refit |> as_tibble() |> count(.predictor.)
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "age") |> 
#   ggplot(aes(age, yhat)) + geom_smooth()
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "bmi") |> 
#   ggplot(aes(bmi, yhat)) + geom_smooth()
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "aerobics_activity") |> 
#   ggplot(aes(aerobics_activity, yhat)) + geom_smooth(se = FALSE)
# p_Glycine_mod_refit |> as_tibble() |> filter(.predictor. == "chronic_disease_v3") |> 
#   ggplot(aes(chronic_disease_v3, yhat)) + geom_point()

thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, sex, fun = exp))
ggplot(Predict(Glycine_mod_refit, age, fun = exp))
ggplot(Predict(Glycine_mod_refit, bmi, fun = exp))
```

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots2
#| fig-cap: "" 
#| fig-width: 8
#| fig-height: 9 

thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, chronic_disease_v3, fun = exp))
```

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots3
#| fig-cap: "" 
#| fig-width: 8 

thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, supplements_flag, fun = exp))
ggplot(Predict(Glycine_mod_refit, aerobics_activity, fun = exp))
ggplot(Predict(Glycine_mod_refit, resistance_activity, fun = exp))
```

```{r}
#| label: fig-Glycine-refit-var-partial-effects-plots4
#| fig-cap: "" 
#| fig-width: 10
 
thematic::thematic_off() 
ggplot(Predict(Glycine_mod_refit, age, sex, fun = exp))
# ggplot(Predict(Glycine_mod_refit, age, chronic_disease_v3, fun = exp)) # 
ggplot(Predict(Glycine_mod_refit, age, supplements_flag, fun = exp))
ggplot(Predict(Glycine_mod_refit, bmi, sex, fun = exp))
# ggplot(Predict(Glycine_mod_refit, bmi, chronic_disease_v3, fun = exp)) # very large upper CI for a case associated with the pain chronic_disease_v3 value, which has only 7 observations in the data; see: 
# p_Glycine_mod_refit |> as_tibble() |> filter(upper > 5000) |> View()
ggplot(Predict(Glycine_mod_refit, bmi, supplements_flag, fun = exp))

# in fig-cap you can put a vector with info i.e. c("plot1","plot2","plot3")
```

## Additional Data Collection & Sample Size Suggestions

The data contains responses from 300 individuals, however the model uses **209** complete cases i.e. the rest contain missing values at various covariates and are thus excluded from modeling (at the moment no imputation technique is used as it is not thought that covariates can predict each other well). The 2nd pass model is built upon most of the covariates and data, and utilizes 29 degrees of freedom. As is mentioned below for the 3rd pass model development, these many degrees of freedom are too many for the current sample size, and as a result the 2nd pass model overfits the data. In order to use and obtain a trustworthy result for the 2nd pass model, the sample size should be about **435** individuals. Given that new data will also contain responses with missing values, the suggestion would be to collect in total about **550** responses or an additional **250** responses.   

## Model - 3rd Pass

The 2nd pass model uses too many degrees of freedom in relation to the size of the data. This can be seen by conducting a validation and calibration analysis. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r, eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Glycine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.27</td>
<td style='padding-left:3ex; text-align: center;'>0.36</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.22</td>
<td style='padding-left:3ex; text-align: center;'>0.05</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.3</td>
<td style='padding-left:3ex; text-align: center;'>0.4</td>
<td style='padding-left:3ex; text-align: center;'>-0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.44</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.41</td>
<td style='padding-left:3ex; text-align: center;'>0.46</td>
<td style='padding-left:3ex; text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>1.99</td>
<td style='padding-left:3ex; text-align: center;'>-1.99</td>
<td style='padding-left:3ex; text-align: center;'>1.99</td>
<td style='padding-left:3ex; text-align: center;'>78</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.69</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.31</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.69</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>78</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">
 
From this table it can be seen that the optimism statistic which indicates the extent of model overfitting, for a variety of performance metrics has values that are large. Thus overfitting is present in the model. 

By calibrating the predicted values from the model to the observed ones, we also notice a good amount of deviation from the diagonal line after correcting for this overfitting or bias. 

```{r}
#| label: fig-Glycine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Glycine_mod_refit_cal)
```

The 2nd pass model also includes the chronic_disease_v3 variable which contains categories with low frequencies in the data. As a result the effect size estimate is accompanied by a very large confidence interval. This renders the estimate as non-trustworthy.  

From these results and also the variable importance plot seen previously as well as the analysis of variance results, it looks like the variables, sex, age and aerobics_activity can be kept in a new model with less degree of freedom spending i.e. less overfitting the data. 

Hence the model is refitted to the data with these three covariates and interactions between sex & age and between age & aerobics_activity. 

The model formula is: 

```{r}
noquote(reg_f_Glycine_refit2)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
dd_refit  
```

### Residuals

```{r}
#| label: fig-Glycine-refit2-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers. Here the algorithm reports outliers due to its parameterization, however these are weak outliers since their deviation from the straight line is not large." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glycine_mod_refit2$outliersPlot  
```

```{r}
#| label: fig-Glycine-refit2-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Glycine_mod_refit2), resid_Glycine_mod_refit2, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Glycine-refit2-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Glycine_mod_refit2), what = "proportion R2", main = "", sort = "ascending", margin = "") 
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Glycine_mod_refit2 
# eval=FALSE after html copy-pasting below
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Glycine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34</td>
<td style='padding-left:4ex; text-align: right;'>53</td>
<td style='padding-left:4ex; text-align: right;'>19</td>
<td style='padding-left:4ex; text-align: right;'>-0.1065</td>
<td style='padding-left:4ex; text-align: right;'>0.08776</td>
<td style='padding-left:4ex; text-align: right;'>-0.2794</td>
<td style='padding-left:4ex; text-align: right;'> 0.066340</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0</td>
<td style='padding-left:4ex; text-align: right;'>60</td>
<td style='padding-left:4ex; text-align: right;'>60</td>
<td style='padding-left:4ex; text-align: right;'>-0.1400</td>
<td style='padding-left:4ex; text-align: right;'>0.07170</td>
<td style='padding-left:4ex; text-align: right;'>-0.2812</td>
<td style='padding-left:4ex; text-align: right;'> 0.001298</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 2</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.5174</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.08392</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.6827</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.352000</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Glycine-refit2-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Glycine_mod_refit2, digits = 1, log = TRUE, main = paste0("% increase/decrease on Glycine reference value of ", round(dd_refit$limits["Glycine"][2,]), " μmol/g (median)"), nb = 3)
```

### Partial Dependence Plots

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot1
#| fig-cap: "Effect of sex. Female subjects seem to have higher levels of Glycine concentration." 
#| fig-width: 8  

ggplot(Predict(Glycine_mod_refit2, sex, fun = exp))
```

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot2
#| fig-cap: "Effect of age. Older subjects seem to have lower levels of Glycine concentration."
#| fig-width: 8 

ggplot(Predict(Glycine_mod_refit2, age, fun = exp))
```

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot3
#| fig-cap: "Effect of aerobics_activity. Aerobics seem to reduce the concentration of Glycine but at a relatively slow pace as the exercise duration increases." 
#| fig-width: 8 

ggplot(Predict(Glycine_mod_refit2, aerobics_activity, fun = exp))
```

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot4
#| fig-cap: "Interaction between sex and age. As age increases the concentration of Glycine between males and females seems to converge to the same value."  
#| fig-width: 8 
ggplot(Predict(Glycine_mod_refit2, age, sex, fun = exp))
```

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot5
#| fig-cap: "Interaction between sex and aerobics_activity. Parallel lines denote no interaction." 
#| fig-width: 8 

ggplot(Predict(Glycine_mod_refit2, aerobics_activity, sex, fun = exp))
```

```{r}
#| label: fig-Glycine-refit2-var-partial-effects-plot6
#| fig-cap: "Simultaneous effects of age and aerobics_activity. Younger/Older subjects with larger aerobic exercise durations seem to have higher/lower concentrations of Glycine. Older subjects who exercise less seem to have higher concentrations of Glycine when compared to older subjects who exercise more."
#| fig-width: 8  
  
# pred_intx is defined in workspace
bplot(pred_intx, yhat ~ age + aerobics_activity, lfun = lattice::wireframe, zlab = "Glycine\n",  screen=list(z=-30, x=-75), ylabrot = 45, cex.lab = 0.55, cex.adj = 0.6)                      
```

### Validation & Calibration 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Glycine_mod_refit2_val, digits = 2, caption = "3rd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
3rd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.18</td>
<td style='padding-left:3ex; text-align: center;'>0.19</td>
<td style='padding-left:3ex; text-align: center;'>0.16</td>
<td style='padding-left:3ex; text-align: center;'>0.03</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.38</td>
<td style='padding-left:3ex; text-align: center;'>0.37</td>
<td style='padding-left:3ex; text-align: center;'>0.39</td>
<td style='padding-left:3ex; text-align: center;'>-0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.4</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.31</td>
<td style='padding-left:3ex; text-align: center;'>0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.31</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.32</td>
<td style='padding-left:3ex; text-align: center;'>-0.32</td>
<td style='padding-left:3ex; text-align: center;'>0.32</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.95</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.05</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.95</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

We note also that the successful number of resamples is 300 (i.e. the number of bootstrap samples that we have chosen to perform the validation). In contrast, the 2nd pass model did not use all of the 300 resamples due to divergence or singularity issues which occurred in 222 samples, and thus left only 78 resamples to use for the validation. These divergence issues were due to reasons such as missing values, categories of the chronic_disease_v3 variable with a low frequency and the complexity of the model.  
In addition this 3rd pass model has used 243 individuals instead of 209 that were used by the 2nd pass model i.e. the smaller number of covariates used in the 3rd pass model have fewer missing values. 

```{r}
#| label: fig-Glycine-refit2-cal
#| fig-cap: "Calibration plot for 3rd pass model. Deviation from the diagonal line after correcting for overfitting or bias. It can be seen that deviations have been reduced compared to the 2nd pass model." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Glycine_mod_refit2_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 3rd pass model only sex, age and aerobics_activity make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Glycine_mod_refit2, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, sex, age, aerobics_activity), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))
# |> relocate(aerobics_activity, .before = bmi) 

dynRI
```

The RI for Glycine from Mayo Clinic Laboratories for ages above 18 years is 229 to 2989 μmol/g of creatinine.

# Alanine

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Alanine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Alanine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datAlanine, p = 2))
abline(v = c(-0.01, 0, 0.01), lty = "dashed")
```

Non-linearity is evident in covariates `sex`, `aerobics_activity`, `age` (smaller $\rho^2$ with opposite sign), `bmi` (smaller $\rho^2$ with opposite sign) and `chronic_disease_v3` ($\rho^2$ with opposite sign).

To capture non-linearities only interactions amongst these 4 variables will be considered in the model. Specifically, the model formula will contain the following terms or associations:

`log(Alanine) ~ sex + age + sex:age + bmi + chronic_disease_v3 + age:chronic_disease_v3 + supplements_flag + log(aerobics_activity+1) + log(resistance_activity+1) + age:log(aerobics_activity+1) + chronic_disease_v3:log(aerobics_activity+1) + sex:bmi + bmi:log(aerobics_activity+1) + age:bmi + bmi:chronic_disease_v3 + bmi:supplements_flag + age:supplements_flag + sex:supplements_flag + sex:log(aerobics_activity+1)`

Where the `:` symbol denotes the interaction between two variables. 

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Alanine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()      
DescTools::Desc(resid_Alanine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Alanine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Alanine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Alanine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Alanine_mod$outliersPlot  
```

```{r}
gt(out_resid_Alanine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Alanine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Alanine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Alanine
    )
  )   
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step. 

### Residuals

```{r}
#| label: fig-Alanine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed weak outliers (the strong ones detected by the 1st pass model have been removed)." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Alanine_mod_refit$outliersPlot  
```

```{r}
#| label: fig-Alanine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Alanine_mod_refit), resid_Alanine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Alanine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Alanine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 19, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Alanine_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Alanine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.25</td>
<td style='padding-left:4ex; text-align: right;'> 53.00</td>
<td style='padding-left:4ex; text-align: right;'> 18.75</td>
<td style='padding-left:4ex; text-align: right;'> 0.002985</td>
<td style='padding-left:4ex; text-align: right;'>0.1982</td>
<td style='padding-left:4ex; text-align: right;'>-0.38840</td>
<td style='padding-left:4ex; text-align: right;'> 0.3943</td>
</tr>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.90</td>
<td style='padding-left:4ex; text-align: right;'> 29.35</td>
<td style='padding-left:4ex; text-align: right;'>  6.45</td>
<td style='padding-left:4ex; text-align: right;'>-0.034680</td>
<td style='padding-left:4ex; text-align: right;'>0.1273</td>
<td style='padding-left:4ex; text-align: right;'>-0.28610</td>
<td style='padding-left:4ex; text-align: right;'> 0.2167</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'> 60.00</td>
<td style='padding-left:4ex; text-align: right;'> 60.00</td>
<td style='padding-left:4ex; text-align: right;'>-0.162800</td>
<td style='padding-left:4ex; text-align: right;'>0.1685</td>
<td style='padding-left:4ex; text-align: right;'>-0.49540</td>
<td style='padding-left:4ex; text-align: right;'> 0.1699</td>
</tr>
<tr>
<td style='text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'>540.00</td>
<td style='padding-left:4ex; text-align: right;'>540.00</td>
<td style='padding-left:4ex; text-align: right;'> 0.023450</td>
<td style='padding-left:4ex; text-align: right;'>0.1954</td>
<td style='padding-left:4ex; text-align: right;'>-0.36220</td>
<td style='padding-left:4ex; text-align: right;'> 0.4092</td>
</tr>
<tr>
<td style='text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  2.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.653700</td>
<td style='padding-left:4ex; text-align: right;'>0.1922</td>
<td style='padding-left:4ex; text-align: right;'>-1.03300</td>
<td style='padding-left:4ex; text-align: right;'>-0.2743</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  2.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.097710</td>
<td style='padding-left:4ex; text-align: right;'>0.2452</td>
<td style='padding-left:4ex; text-align: right;'>-0.58180</td>
<td style='padding-left:4ex; text-align: right;'> 0.3863</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  3.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.250300</td>
<td style='padding-left:4ex; text-align: right;'>0.2391</td>
<td style='padding-left:4ex; text-align: right;'>-0.22160</td>
<td style='padding-left:4ex; text-align: right;'> 0.7223</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  4.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.320000</td>
<td style='padding-left:4ex; text-align: right;'>0.4643</td>
<td style='padding-left:4ex; text-align: right;'>-1.23700</td>
<td style='padding-left:4ex; text-align: right;'> 0.5966</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  5.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.539600</td>
<td style='padding-left:4ex; text-align: right;'>0.5862</td>
<td style='padding-left:4ex; text-align: right;'>-0.61760</td>
<td style='padding-left:4ex; text-align: right;'> 1.6970</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  6.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.149300</td>
<td style='padding-left:4ex; text-align: right;'>0.4837</td>
<td style='padding-left:4ex; text-align: right;'>-1.10400</td>
<td style='padding-left:4ex; text-align: right;'> 0.8057</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  7.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.023430</td>
<td style='padding-left:4ex; text-align: right;'>0.6691</td>
<td style='padding-left:4ex; text-align: right;'>-1.29800</td>
<td style='padding-left:4ex; text-align: right;'> 1.3440</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  8.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 2.103000</td>
<td style='padding-left:4ex; text-align: right;'>1.0820</td>
<td style='padding-left:4ex; text-align: right;'>-0.03355</td>
<td style='padding-left:4ex; text-align: right;'> 4.2400</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>supplements_flag --- Yes:No</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>  2.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.367900</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.1704</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.03139</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.7044</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Alanine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Alanine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Alanine reference value of ", round(ddAlanine_refit$limits["Alanine"][2,]), " μmol/g (median)"), nb = 14)
```

## Model - 3rd Pass

The 2nd pass model uses too many degrees of freedom in relation to the size of the data. This can be seen by conducting a validation and calibration analysis. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Alanine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.32</td>
<td style='padding-left:3ex; text-align: center;'>0.46</td>
<td style='padding-left:3ex; text-align: center;'>-0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.79</td>
<td style='padding-left:3ex; text-align: center;'>-0.47</td>
<td style='padding-left:3ex; text-align: center;'>14</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.48</td>
<td style='padding-left:3ex; text-align: center;'>0.38</td>
<td style='padding-left:3ex; text-align: center;'>0.94</td>
<td style='padding-left:3ex; text-align: center;'>-0.56</td>
<td style='padding-left:3ex; text-align: center;'>1.03</td>
<td style='padding-left:3ex; text-align: center;'>14</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.53</td>
<td style='padding-left:3ex; text-align: center;'>0.64</td>
<td style='padding-left:3ex; text-align: center;'>0.35</td>
<td style='padding-left:3ex; text-align: center;'>0.29</td>
<td style='padding-left:3ex; text-align: center;'>0.24</td>
<td style='padding-left:3ex; text-align: center;'>14</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>3.02</td>
<td style='padding-left:3ex; text-align: center;'>-3.02</td>
<td style='padding-left:3ex; text-align: center;'>3.02</td>
<td style='padding-left:3ex; text-align: center;'>14</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.5</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.5</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.5</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>14</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

From this table it can be seen that the optimism statistic which indicates the extent of model overfitting, for a variety of performance metrics has values that are large. Thus overfitting is present in the model. 

By calibrating the predicted values from the model to the observed ones, we also notice a good amount of deviation from the diagonal line (ideal model performance) after correcting for this overfitting or bias. 

```{r}
#| label: fig-Alanine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Alanine_mod_refit_cal)
```

The 2nd pass model also includes the chronic_disease_v3 variable which contains categories with low frequencies in the data. As a result the effect size estimate is accompanied by a very large confidence interval. This renders the estimate as non-trustworthy.  

From these results and also the variable importance plot seen previously as well as the analysis of variance results, it looks like the variables, sex and supplements_flag can be kept in a new model with less degree of freedom spending i.e. less overfitting the data. 

Hence the model is refitted to the data with these just 2 covariates (Note: Situation might change when more data are collected and the model is refit).

The model formula is: 

```{r}
noquote(reg_f_Alanine_refit2)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddAlanine_refit  
```

### Residuals

```{r}
#| label: fig-Alanine-refit2-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers. Here the algorithm reports outliers due to its parameterization, however these are weak outliers since their deviation from the straight line is not large." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Alanine_mod_refit2$outliersPlot  
```

```{r}
#| label: fig-Alanine-refit2-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen. Since the model covariates are binary, there are four unique predictions, one for each combination of sex and supplements_flag category." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Alanine_mod_refit2), resid_Alanine_mod_refit2, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Alanine-refit2-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Alanine_mod_refit2), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 2, nx = NA, col = "black")
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Alanine_mod_refit2 
# eval=FALSE after html copy-pasting below
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Alanine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; text-align: right;'>1</td>
<td style='padding-left:4ex; text-align: right;'>2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.5242</td>
<td style='padding-left:4ex; text-align: right;'>0.1029</td>
<td style='padding-left:4ex; text-align: right;'>-0.72690</td>
<td style='padding-left:4ex; text-align: right;'>-0.3214</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>supplements_flag --- Yes:No</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>1</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>2</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.1736</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.1061</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.03533</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.3825</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Alanine-refit2-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Alanine_mod_refit2, digits = 1, log = TRUE, main = paste0("% increase/decrease on Alanine reference value of ", round(ddAlanine_refit$limits["Alanine"][2,]), " μmol/g (median)")) # nb = 5 reduces the spacing between the CIs, looks better without it on the site
```

### Partial Dependence Plots

```{r}
#| label: fig-Alanine-refit2-var-partial-effects-plot1
#| fig-cap: "Effect of sex. Female subjects seem to have higher levels of Alanine concentration." 
#| fig-width: 8  

ggplot(Predict(Alanine_mod_refit2, sex, fun = exp))
```

```{r}
#| label: fig-Alanine-refit2-var-partial-effects-plot2
#| fig-cap: "Effect of supplement intake. Taking supplements seems to increase levels of Alanine concentration, but without strong evidence."
#| fig-width: 8 

ggplot(Predict(Alanine_mod_refit2, supplements_flag, fun = exp))
```

### Validation & Calibration 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Alanine_mod_refit2_val, digits = 2, caption = "3rd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
3rd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.11</td>
<td style='padding-left:3ex; text-align: center;'>0.11</td>
<td style='padding-left:3ex; text-align: center;'>0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.09</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.62</td>
<td style='padding-left:3ex; text-align: center;'>0.61</td>
<td style='padding-left:3ex; text-align: center;'>0.62</td>
<td style='padding-left:3ex; text-align: center;'>-0.01</td>
<td style='padding-left:3ex; text-align: center;'>0.63</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.29</td>
<td style='padding-left:3ex; text-align: center;'>0.29</td>
<td style='padding-left:3ex; text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>0.01</td>
<td style='padding-left:3ex; text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.1</td>
<td style='padding-left:3ex; text-align: center;'>-0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.1</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.98</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.02</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.98</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

We note also that the successful number of resamples is 300 (i.e. the number of bootstrap samples that we have chosen to perform the validation). In contrast, the 2nd pass model did not use all of the 300 resamples due to divergence or singularity issues which occurred in 286 samples, and thus left only 14 resamples to use for the validation. These divergence issues were due to reasons such as missing values, categories of the chronic_disease_v3 variable with a low frequency and the complexity of the model.  
In addition this 3rd pass model has used 254 individuals instead of 213 that were used by the 2nd pass model i.e. the smaller number of covariates used in the 3rd pass model have fewer missing values. 

```{r}
#| label: fig-Alanine-refit2-cal
#| fig-cap: "Calibration plot for 3rd pass model. Deviation from the diagonal line after correcting for overfitting or bias. It can be seen that deviations have been reduced compared to the 2nd pass model." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Alanine_mod_refit2_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 3rd pass model only sex and supplements_flag make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Alanine_mod_refit2, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, sex, supplements_flag), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))

dynRI
```

The RI for Alanine from Mayo Clinic Laboratories for ages above 18 years is 56 to 560 μmol/g of creatinine.

# Valine

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Valine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Valine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datValine, p = 2))
abline(v = c(-0.01/3, 0.01/3), lty = "dashed")
grid(ny = 9, nx = NA, col = "black")
```

Non-linearity is evident in covariates `sex`, `resistance_activity`, `bmi` and `chronic_disease_v3`. However their $\rho^2$ values are very small, hence non-linearity strength is very low.

To capture non-linearities only interactions amongst these 4 variables are considered in the model. Specifically, the model formula contains the following terms or associations:

log(Valine) ~ sex + age + bmi + chronic_disease_v3 + supplements_flag + log(aerobics_activity+1) + log(resistance_activity+1) + sex:bmi + sex:log(resistance_activity+1) + log(resistance_activity+1):chronic_disease_v3 + log(resistance_activity+1):bmi

Where the `:` symbol denotes the interaction between two variables. 

Even though this model uses information from all meta data covariates, and is in addition quite complex due to the modeled interactions, the global significance of the model is very small i.e. global p-value based on the Likelihood Ratio Test is 0.62, well above the 0.05 typical threshold. 
As a result, and after different combinations of the covariates were tested in the model, the best model was the one including only bmi and resistance_activity as covariates. This model had a global regression p-value of 0.0542 (marginally significant). 
To note, this statistic is further improved with the 2nd pass model below i.e. p-value of 0.0175

Thus the 1st pass model formula is:

`log(Valine) ~ bmi + log(resistance_activity+1)`

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Valine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()       
DescTools::Desc(resid_Valine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Valine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Valine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Valine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Valine_mod$outliersPlot   
```

```{r}
gt(out_resid_Valine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Valine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Valine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Valine
    )
  )    
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step. 

### Residuals

```{r}
#| label: fig-Valine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed weak outliers (the strong ones detected by the 1st pass model have been removed)." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Valine_mod_refit$outliersPlot   
```

```{r}
#| label: fig-Valine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Valine_mod_refit), resid_Valine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Valine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Valine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 2, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Valine_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Valine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.8</td>
<td style='padding-left:4ex; text-align: right;'> 29.1</td>
<td style='padding-left:4ex; text-align: right;'>  6.3</td>
<td style='padding-left:4ex; text-align: right;'> 0.05646</td>
<td style='padding-left:4ex; text-align: right;'>0.03123</td>
<td style='padding-left:4ex; text-align: right;'>-0.005082</td>
<td style='padding-left:4ex; text-align: right;'>0.118000</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>450.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>450.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.14610</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.07464</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.293200</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.001033</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Valine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Valine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Valine reference value of ", round(ddValine_refit$limits["Valine"][2,]), " μmol/g (median)"))
```

For Valine, there's no 3rd pass model since the 2nd pass is built on just 2 covariates and does not overfit.

The model formula is: 

```{r}
noquote(reg_f_Valine_refit)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddValine_refit  
```

### Partial Dependence Plots

```{r}
#| label: fig-Valine-refit-var-partial-effects-plot1
#| fig-cap: "Effect of bmi. Valine concentration increasing with bmi on average." 
#| fig-width: 8  

ggplot(Predict(Valine_mod_refit, bmi, fun = exp))
```

```{r}
#| label: fig-Valine-refit-var-partial-effects-plot2
#| fig-cap: "Effect of resistance training. Spending more time on resistance training seems to decrease levels of Valine concentration, but at a relatively slow pace. The effect is more prominent from no resistance training to about 4 hours per week i.e. 250/60"
#| fig-width: 8 

ggplot(Predict(Valine_mod_refit, resistance_activity, fun = exp))
```

```{r}
#| label: fig-Valine-refit-var-partial-effects-plot3
#| fig-cap: "Simultaneous effects of bmi and resistance_activity. Individuals who do not include resistance training in their fitness program have higher levels of Valine concentration, and those levels increase with the bmi."
#| fig-width: 8  
  
# pred_intx_Valine is defined in workspace
bplot(pred_intx_Valine, yhat ~ bmi + resistance_activity, lfun = lattice::wireframe, zlab = "Valine\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6)
```

### Validation & Calibration 

To assess model performance, a validation and calibration analysis is conducted below as with other amino acids. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Valine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.01</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>0.14</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.09</td>
<td style='padding-left:3ex; text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.01</td>
<td style='padding-left:3ex; text-align: center;'>0.07</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.17</td>
<td style='padding-left:3ex; text-align: center;'>-0.17</td>
<td style='padding-left:3ex; text-align: center;'>0.17</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.95</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.05</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.95</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

```{r}
#| label: fig-Valine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias. The larger deviations occur to the left of the plot which means that the model has some tendency to underestimate the true Valine concentration value i.e. if the model predicts 23.33 μmol/g, then actual is 23.33*exp(mae=0.015) = 23.68 μmol/g" 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Valine_mod_refit_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 2nd pass model only bmi and resistance_activity make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Valine_mod_refit, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, bmi, resistance_activity), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))

dynRI
```

The RI for Valine from Mayo Clinic Laboratories for ages above 18 years is 11 to 88 μmol/g of creatinine.

# Cysteine

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Cysteine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Cysteine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datCysteineNoZeroes, p = 2, na.action = na.omit))
abline(v = c(-0.02/2, 0.02/2), lty = "dashed")
grid(ny = 9, nx = NA, col = "black")
```

Non-linearity evident in bmi, resistance_activity (smaller $\rho^2$ with opposite sign), chronic_disease_v3 (smaller $\rho^2$ with opposite sign). Most rho values are relatively small though with bmi being the exception 

To capture non linearities interactions amongst these 3 variables will be considered, as well as splines for bmi. Also age will be included as it has some linearity association: 

`log(Cysteine) ~ rcs(bmi, 4) + age + chronic_disease_v3 + log(resistance_activity+1) + log(resistance_activity+1):rcs(bmi, 4)`

Where the `:` symbol denotes the interaction between two variables and rcs denotes a restricted cubic spline transformation with 4 knots. 

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Cysteine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()      
DescTools::Desc(resid_Cysteine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Cysteine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Cysteine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Cysteine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Cysteine_mod$outliersPlot
```

```{r}
gt(out_resid_Cysteine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Cysteine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Cysteine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Cysteine
    )
  )
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step. 

### Residuals

```{r}
#| label: fig-Cysteine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed weak outliers (the strong ones detected by the 1st pass model have been removed)." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Cysteine_mod_refit$outliersPlot
```

```{r}
#| label: fig-Cysteine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Cysteine_mod_refit), resid_Cysteine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Cysteine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Cysteine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 5, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Cysteine_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Cysteine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>23.25</td>
<td style='padding-left:4ex; text-align: right;'>30.3</td>
<td style='padding-left:4ex; text-align: right;'> 7.05</td>
<td style='padding-left:4ex; text-align: right;'> 0.32730</td>
<td style='padding-left:4ex; text-align: right;'>0.19520</td>
<td style='padding-left:4ex; text-align: right;'>-0.058600</td>
<td style='padding-left:4ex; text-align: right;'>0.71330</td>
</tr>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>35.00</td>
<td style='padding-left:4ex; text-align: right;'>52.0</td>
<td style='padding-left:4ex; text-align: right;'>17.00</td>
<td style='padding-left:4ex; text-align: right;'> 0.11730</td>
<td style='padding-left:4ex; text-align: right;'>0.08842</td>
<td style='padding-left:4ex; text-align: right;'>-0.057530</td>
<td style='padding-left:4ex; text-align: right;'>0.29220</td>
</tr>
<tr>
<td style='text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'>42.5</td>
<td style='padding-left:4ex; text-align: right;'>42.50</td>
<td style='padding-left:4ex; text-align: right;'> 0.29170</td>
<td style='padding-left:4ex; text-align: right;'>0.14650</td>
<td style='padding-left:4ex; text-align: right;'> 0.002049</td>
<td style='padding-left:4ex; text-align: right;'>0.58130</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 2.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.07755</td>
<td style='padding-left:4ex; text-align: right;'>0.19310</td>
<td style='padding-left:4ex; text-align: right;'>-0.459400</td>
<td style='padding-left:4ex; text-align: right;'>0.30430</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 3.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.15410</td>
<td style='padding-left:4ex; text-align: right;'>0.21360</td>
<td style='padding-left:4ex; text-align: right;'>-0.268300</td>
<td style='padding-left:4ex; text-align: right;'>0.57640</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 4.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.05171</td>
<td style='padding-left:4ex; text-align: right;'>0.24080</td>
<td style='padding-left:4ex; text-align: right;'>-0.424500</td>
<td style='padding-left:4ex; text-align: right;'>0.52790</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 5.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.16380</td>
<td style='padding-left:4ex; text-align: right;'>0.30430</td>
<td style='padding-left:4ex; text-align: right;'>-0.765500</td>
<td style='padding-left:4ex; text-align: right;'>0.43800</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 6.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.12680</td>
<td style='padding-left:4ex; text-align: right;'>0.28320</td>
<td style='padding-left:4ex; text-align: right;'>-0.686700</td>
<td style='padding-left:4ex; text-align: right;'>0.43310</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'> 7.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.71560</td>
<td style='padding-left:4ex; text-align: right;'>0.37190</td>
<td style='padding-left:4ex; text-align: right;'>-1.451000</td>
<td style='padding-left:4ex; text-align: right;'>0.01981</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 8.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.22440</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.43780</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.641200</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>1.09000</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Cysteine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Cysteine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Cysteine reference value of ", round(ddCysteine_refit$limits["Cysteine"][2,]), " μmol/g (median)"), nb = 14)
```

## Model - 3rd Pass

The 2nd pass model uses too many degrees of freedom (df) in relation to the size of the data i.e. 10 df should be spent instead of the 16 from the model. This can be seen by conducting a validation and calibration analysis. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Cysteine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>0.21</td>
<td style='padding-left:3ex; text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>0.18</td>
<td style='padding-left:3ex; text-align: center;'>-0.03</td>
<td style='padding-left:3ex; text-align: center;'>278</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.47</td>
<td style='padding-left:3ex; text-align: center;'>0.43</td>
<td style='padding-left:3ex; text-align: center;'>0.52</td>
<td style='padding-left:3ex; text-align: center;'>-0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.56</td>
<td style='padding-left:3ex; text-align: center;'>278</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.31</td>
<td style='padding-left:3ex; text-align: center;'>0.37</td>
<td style='padding-left:3ex; text-align: center;'>0.24</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.18</td>
<td style='padding-left:3ex; text-align: center;'>278</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.96</td>
<td style='padding-left:3ex; text-align: center;'>-0.96</td>
<td style='padding-left:3ex; text-align: center;'>0.96</td>
<td style='padding-left:3ex; text-align: center;'>278</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.63</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.37</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.63</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>278</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

From this table it can be seen that the optimism statistic which indicates the extent of model overfitting, for a variety of performance metrics has values that are large. Thus overfitting is present in the model. 

By calibrating the predicted values from the model to the observed ones, we also notice a good amount of deviation from the diagonal line (ideal model performance) after correcting for this overfitting or bias. 

```{r}
#| label: fig-Cysteine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Cysteine_mod_refit_cal)
```

The 2nd pass model also includes the chronic_disease_v3 variable which contains categories with low frequencies in the data. As a result the effect size estimate is accompanied by a very large confidence interval. This renders the estimate as non-trustworthy.  

From these results and also the variable importance plot seen previously as well as the analysis of variance results, it looks like the variables, bmi, age and resistance_activity can be kept in a new model with less degree of freedom spending i.e. less overfitting the data. 

Hence the model is refitted to the data with these just 3 covariates (Note: Situation might change when more data are collected and the model is refit).

The model formula is: 

```{r}
noquote(reg_f_Cysteine_refit2)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddCysteine_refit  
```

### Residuals

```{r}
#| label: fig-Cysteine-refit2-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers. Here the algorithm reports outliers due to its parameterization, however these are weak outliers since their deviation from the straight line is not large." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Cysteine_mod_refit2$outliersPlot
```

```{r}
#| label: fig-Cysteine-refit2-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Cysteine_mod_refit2), resid_Cysteine_mod_refit2, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Cysteine-refit2-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Cysteine_mod_refit2), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 4, nx = NA, col = "black")
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Cysteine_mod_refit2 
# eval=FALSE after html copy-pasting below
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Cysteine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>23.25</td>
<td style='padding-left:4ex; text-align: right;'>30.3</td>
<td style='padding-left:4ex; text-align: right;'> 7.05</td>
<td style='padding-left:4ex; text-align: right;'>0.3326</td>
<td style='padding-left:4ex; text-align: right;'>0.19120</td>
<td style='padding-left:4ex; text-align: right;'>-0.04525</td>
<td style='padding-left:4ex; text-align: right;'>0.7104</td>
</tr>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>35.00</td>
<td style='padding-left:4ex; text-align: right;'>52.0</td>
<td style='padding-left:4ex; text-align: right;'>17.00</td>
<td style='padding-left:4ex; text-align: right;'>0.1207</td>
<td style='padding-left:4ex; text-align: right;'>0.07642</td>
<td style='padding-left:4ex; text-align: right;'>-0.03035</td>
<td style='padding-left:4ex; text-align: right;'>0.2717</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>42.5</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>42.50</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.2620</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.14040</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.01559</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.5395</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Cysteine-refit2-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Cysteine_mod_refit2, digits = 1, log = TRUE, main = paste0("% increase/decrease on Cysteine reference value of ", round(ddCysteine_refit$limits["Cysteine"][2,]), " μmol/g (median)"), nb = 4) # nb = 4 reduces the spacing between the CIs, looks better without it on the site
```

### Partial Dependence Plots

```{r}
#| label: fig-Cysteine-refit2-var-partial-effects-plot1
#| fig-cap: "Nonlinear effect of bmi. Cysteine concentration levels can be seen to decrease until the age of 24 and thereafter steadily but slowly increase with increasing bmi." 
#| fig-width: 8  

ggplot(Predict(Cysteine_mod_refit2, bmi, fun = exp))
```

```{r}
#| label: fig-Cysteine-refit2-var-partial-effects-plot2
#| fig-cap: "Effect of age. Age is seen to increase the levels of Cysteine concentration."
#| fig-width: 8 

ggplot(Predict(Cysteine_mod_refit2, age, fun = exp))
```

```{r}
#| label: fig-Cysteine-refit2-var-partial-effects-plot3
#| fig-cap: "Effect of resistance_activity. Resistance training is seen to increase the levels of Cysteine concentration, especially when moving from no training at all to increasing training durations per week. The pace of increase is slow."
#| fig-width: 8 

ggplot(Predict(Cysteine_mod_refit2, resistance_activity, fun = exp))
```

```{r}
#| label: fig-Cysteine-refit2-var-partial-effects-plot4
#| fig-cap: "Simultaneous effects of bmi and resistance_activity. Cysteine concentration levels are seen to increase with the increase of bmi and the duration of resistance training, particularly beyond the bmi threshold of 35 $kg/m^2$"
#| fig-width: 8  
  
# pred_intx_Cysteine is defined in workspace
bplot(pred_intx_Cysteine, yhat ~ bmi + resistance_activity, lfun = lattice::wireframe, zlab = "Cysteine\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6)
```

### Validation & Calibration 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Cysteine_mod_refit2_val, digits = 2, caption = "3rd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
3rd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.11</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>0.05</td>
<td style='padding-left:3ex; text-align: center;'>0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.01</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.48</td>
<td style='padding-left:3ex; text-align: center;'>0.46</td>
<td style='padding-left:3ex; text-align: center;'>0.52</td>
<td style='padding-left:3ex; text-align: center;'>-0.06</td>
<td style='padding-left:3ex; text-align: center;'>0.55</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>0.31</td>
<td style='padding-left:3ex; text-align: center;'>0.23</td>
<td style='padding-left:3ex; text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.2</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.64</td>
<td style='padding-left:3ex; text-align: center;'>-0.64</td>
<td style='padding-left:3ex; text-align: center;'>0.64</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.75</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.25</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.75</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

We note also that the successful number of resamples is 300 (i.e. the number of bootstrap samples that we have chosen to perform the validation). In contrast, the 2nd pass model did not use all of the 300 resamples due to divergence or singularity issues which occurred in 22 samples, and thus left only 278 resamples to use for the validation. These divergence issues were due to reasons such as missing values, categories of the chronic_disease_v3 variable with a low frequency and the complexity of the model.  
In addition this 3rd pass model has used only 154 individuals from the current pool of 308 due the many zero or non-detection cases in the data. 

```{r}
#| label: fig-Cysteine-refit2-cal
#| fig-cap: "Calibration plot for 3rd pass model. Deviation from the diagonal line after correcting for overfitting or bias. It can be seen that deviations have been reduced compared to the 2nd pass model, especially on the right side, but not on the middle and left parts of the comparison. On the middle part there is some overestimation while on the left there is underestimation of the true values. This is perhaps due to the currently small sample size of 154 individuals upon which the models have been built." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Cysteine_mod_refit2_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 3rd pass model only bmi, age and resistance_activity make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Cysteine_mod_refit2, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, bmi, age, resistance_activity), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))

dynRI
```

The RI for Cysteine from Mayo Clinic Laboratories for ages above 18 years is 12 to 98 μmol/g of creatinine.

# Taurine

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Taurine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Taurine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datTaurine, p = 2, na.action = na.omit))
abline(v = c(-0.01/2, 0.01/2), lty = "dashed")
grid(ny = 9, nx = NA, col = "black")
```

Linearity is evident in `aerobics_activity` (relevant plot not shown). 
Non-linearity is evident in covariates `age`, `resistance_activity`, `bmi` and `chronic_disease_v3`. However their $\rho^2$ values are very small, hence non-linearity strength is very low.

To capture non-linearities only interactions amongst these 5 variables are considered in the model.

After different combinations of the covariates were tested in the model, the best model was the one including only aerobics_activity as the single covariate. This model had a global regression p-value of `0.078` (marginally significant). 

Thus the 1st pass model formula is:

`log(Taurine) ~ log(aerobics_activity+1)`

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Taurine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()       
DescTools::Desc(resid_Taurine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Taurine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Taurine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Taurine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Taurine_mod$outliersPlot   
```

```{r}
gt(out_resid_Taurine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Taurine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Taurine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Taurine
    )
  )    
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step. 

Utilizing the same model formula as in the 1st pass model i.e. a model with only aerobics_activity as a covariate did not result into global regression significance. As a result a new model formula was searched with the following being the best found:

`log(Taurine) ~ rcs(age,3) + supplements_flag + rcs(age,3):supplements_flag + log(aerobics_activity+1) + supplements_flag:log(aerobics_activity+1) + sex + sex:supplements_flag`

Where `:` denotes an interaction term and `rcs` a restricted cubic spline to capture non-linear association. 
However this model, even after an extensive search using a variety of covariate combinations, still does not have global regression significance with a p-value close to `0.14`. 
Since this is currently the only option, this model is kept as the 2nd pass model (it is hoped that with more data global regression significance can be achieved). 

### Residuals & Model Refit

```{r}
#| label: fig-Taurine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are typically deemed weak outliers (the strong ones detected by the 1st pass model have been removed). An exception for the Taurine case is that there's still is a strong outlier present, which can be seen on the right side of the plot. This data point is further removed from the data and the 2nd pass model is refit again." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Taurine_mod_refit$outliersPlot   
```

As an exception to previously analysed amino acids, here there was an additional strong outlier that was removed from the data. This corresponds to the subject id `34734` as shown in the table below. 

```{r}
gt(out_resid_Taurine_mod_refit$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Taurine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Taurine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Taurine
    )
  )   
# positive error: i.e. log(3000)-log(100)
```

The 2nd pass model was then refit one more time (without id `34734`) using the same last model formula:

`log(Taurine) ~ rcs(age,3) + supplements_flag + rcs(age,3):supplements_flag + log(aerobics_activity+1) + supplements_flag:log(aerobics_activity+1) + sex + sex:supplements_flag`

This version of the model resulted in marginal globla regression significance with a p-value of `0.06` and the updated residual qq plot below.

```{r}
#| label: fig-Taurine-refit-resid2-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are typically deemed weak outliers (the strong ones detected by the 1st and 2nd pass models have been removed)." 

out_resid_Taurine_mod_refit2$outliersPlot   
```

```{r}
#| label: fig-Taurine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Taurine_mod_refit), resid_Taurine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Taurine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Taurine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 7, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Taurine_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Taurine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34</td>
<td style='padding-left:4ex; text-align: right;'>53</td>
<td style='padding-left:4ex; text-align: right;'>19</td>
<td style='padding-left:4ex; text-align: right;'> 0.08265</td>
<td style='padding-left:4ex; text-align: right;'>0.1115</td>
<td style='padding-left:4ex; text-align: right;'>-0.13700</td>
<td style='padding-left:4ex; text-align: right;'>0.30230</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0</td>
<td style='padding-left:4ex; text-align: right;'>60</td>
<td style='padding-left:4ex; text-align: right;'>60</td>
<td style='padding-left:4ex; text-align: right;'> 0.09023</td>
<td style='padding-left:4ex; text-align: right;'>0.1387</td>
<td style='padding-left:4ex; text-align: right;'>-0.18300</td>
<td style='padding-left:4ex; text-align: right;'>0.36350</td>
</tr>
<tr>
<td style='text-align: left;'>supplements_flag --- Yes:No</td>
<td style='padding-left:4ex; text-align: right;'> 1</td>
<td style='padding-left:4ex; text-align: right;'> 2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.39710</td>
<td style='padding-left:4ex; text-align: right;'>0.2221</td>
<td style='padding-left:4ex; text-align: right;'>-0.04059</td>
<td style='padding-left:4ex; text-align: right;'>0.83470</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 2</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.22530</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.1606</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.54160</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.09108</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Taurine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Taurine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Taurine reference value of ", round(ddTaurine_refit$limits["Taurine"][2,]), " μmol/g (median)"), nb = 5)
```

For Taurine, there's no 3rd pass model due to the difficulties in establishing a significant model and the fact that 10 degrees of freedom are spent by the model from an empirical max of 16. 

The model formula is: 

```{r}
noquote(reg_f_Taurine_refit)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddTaurine_refit  
```

### Partial Dependence Plots

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot1
#| fig-cap: "Effect of age. U-shaped average effect on Taurine concentration. Young and old subjects exhibit an increase in Taurine concentration with the pace of increase being stronger for older subjects." 
#| fig-width: 8  

ggplot(Predict(Taurine_mod_refit, age, fun = exp))
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot2
#| fig-cap: "Effect of aerobics training. Spending more time on aerobics training seems to increase levels of Taurine concentration, but at a relatively slow pace. The effect is more prominent from no resistance training to about 3 hours per week i.e. 180/60"
#| fig-width: 8 

ggplot(Predict(Taurine_mod_refit, aerobics_activity, fun = exp))
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot3
#| fig-cap: "Effect of supplements intake. Taking supplenents increase the Taurine concentration but the difference from non-takers is not significant."
#| fig-width: 8 

ggplot(Predict(Taurine_mod_refit, supplements_flag, fun = exp))
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot4
#| fig-cap: "Effect of sex. No difference between males and females."
#| fig-width: 8 

ggplot(Predict(Taurine_mod_refit, sex, fun = exp))
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot5
#| fig-cap: "Simultaneous effects of supplement intake and age. Individuals who are either old and do not take any supplements or who are young and do take supplements have higher levels of Taurine concentration."
#| fig-width: 8  
  
# pred_intx1_Taurine is defined in workspace
bplot(pred_intx1_Taurine, yhat ~ supplements_flag + age, lfun = lattice::wireframe, zlab = "Taurine\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6, xlabrot = -40)
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot6
#| fig-cap: "Simultaneous effects of supplement intake and sex. Males who do take supplements have higher levels of Taurine concentration."
#| fig-width: 8  
  
# pred_intx2_Taurine is defined in workspace
bplot(pred_intx2_Taurine, yhat ~ supplements_flag + sex, lfun = lattice::wireframe, zlab = "Taurine\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6, xlabrot = -40)
```

```{r}
#| label: fig-Taurine-refit-var-partial-effects-plot7
#| fig-cap: "Simultaneous effects of supplement intake and aerobics_activity. Individuals who do not follow an aerobic activity but take supplements tend to have higher levels of Taurine concentration."
#| fig-width: 8  
  
# pred_intx3_Taurine is defined in workspace
bplot(pred_intx3_Taurine, yhat ~ supplements_flag + aerobics_activity, lfun = lattice::wireframe, zlab = "Taurine\n",  screen=list(z=320, x=-75), cex.lab = 0.55, cex.adj = 0.6, xlabrot = -24, ylabrot = 30)
```

### Validation & Calibration 

To assess model performance, a validation and calibration analysis is conducted below as with other amino acids. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Taurine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.06</td>
<td style='padding-left:3ex; text-align: center;'>0.1</td>
<td style='padding-left:3ex; text-align: center;'>0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>-0.02</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.88</td>
<td style='padding-left:3ex; text-align: center;'>0.84</td>
<td style='padding-left:3ex; text-align: center;'>0.92</td>
<td style='padding-left:3ex; text-align: center;'>-0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.96</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.27</td>
<td style='padding-left:3ex; text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.22</td>
<td style='padding-left:3ex; text-align: center;'>0.12</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>2.28</td>
<td style='padding-left:3ex; text-align: center;'>-2.28</td>
<td style='padding-left:3ex; text-align: center;'>2.28</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.65</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.35</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.65</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

```{r}
#| label: fig-Taurine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias. The larger deviations occur to the right of the plot which means that the model has some tendency to overestimate the true Taurine concentration value i.e. if the model predicts exp(7) = 1000 μmol/g, then actual is 1000*exp(mae=-0.059) = 943 μmol/g ~ exp(6.8)" 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Taurine_mod_refit_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 2nd pass model only age, supplements_flag, aerobics_activity and sex make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Taurine_mod_refit, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> 
               select(id, age, supplements_flag, aerobics_activity, sex), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))

dynRI
```

The RI for Taurine from Mayo Clinic Laboratories for ages above 18 years is 24 to 1560 μmol/g of creatinine.

# Isoleucine

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Isoleucine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Isoleucine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datIsoleucine, p = 2, na.action = na.omit))
abline(v = c(-0.01/2, 0.01/2), lty = "dashed")
grid(ny = 9, nx = NA, col = "black")
```

Non-linearity evident in chronic_disease_v3, age, sex, bmi and aerobics_activity (smaller $\rho^2$ with opposite sign). Most $\rho^2$ values are relatively small.

To capture non linearities interactions amongst these 5 variables will be considered, as well as spline transformations. The model achieving the best global significance (p-value = `0.0487`) contained the following terms: 

`log(Isoleucine) ~ sex + rcs(age,3) + bmi + chronic_disease_v3 + sex:rcs(age,3)`

Where the `:` symbol denotes the interaction between two variables and rcs denotes a restricted cubic spline transformation with 3 knots. 

Since this is a 1st pass for the model, with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 

## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Isoleucine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()      
DescTools::Desc(resid_Isoleucine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Isoleucine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Isoleucine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Isoleucine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Isoleucine_mod$outliersPlot
```

```{r}
gt(out_resid_Isoleucine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Isoleucine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Isoleucine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Isoleucine
    )
  )
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the outlier values detected in the previous step. The model formula is the same with the only difference that now 3 knots are used for the spline transformations instead of 4 previous, since 3 knots gave a better global regression significance (p-value = `0.0112`). 

### Residuals

```{r}
#| label: fig-Isoleucine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed weak outliers (the strong ones detected by the 1st pass model have been removed)." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Isoleucine_mod_refit$outliersPlot
```

```{r}
#| label: fig-Isoleucine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Isoleucine_mod_refit), resid_Isoleucine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Isoleucine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Isoleucine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 5, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Isoleucine_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Isoleucine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.0</td>
<td style='padding-left:4ex; text-align: right;'>53.0</td>
<td style='padding-left:4ex; text-align: right;'>19.0</td>
<td style='padding-left:4ex; text-align: right;'> 0.140000</td>
<td style='padding-left:4ex; text-align: right;'>0.14600</td>
<td style='padding-left:4ex; text-align: right;'>-0.147800</td>
<td style='padding-left:4ex; text-align: right;'> 0.42790</td>
</tr>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.8</td>
<td style='padding-left:4ex; text-align: right;'>29.3</td>
<td style='padding-left:4ex; text-align: right;'> 6.5</td>
<td style='padding-left:4ex; text-align: right;'> 0.096760</td>
<td style='padding-left:4ex; text-align: right;'>0.04975</td>
<td style='padding-left:4ex; text-align: right;'>-0.001349</td>
<td style='padding-left:4ex; text-align: right;'> 0.19490</td>
</tr>
<tr>
<td style='text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 2.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.292800</td>
<td style='padding-left:4ex; text-align: right;'>0.10700</td>
<td style='padding-left:4ex; text-align: right;'>-0.503900</td>
<td style='padding-left:4ex; text-align: right;'>-0.08180</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 2.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.104700</td>
<td style='padding-left:4ex; text-align: right;'>0.11710</td>
<td style='padding-left:4ex; text-align: right;'>-0.335600</td>
<td style='padding-left:4ex; text-align: right;'> 0.12630</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 3.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.026270</td>
<td style='padding-left:4ex; text-align: right;'>0.13670</td>
<td style='padding-left:4ex; text-align: right;'>-0.243300</td>
<td style='padding-left:4ex; text-align: right;'> 0.29580</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 4.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.001275</td>
<td style='padding-left:4ex; text-align: right;'>0.17790</td>
<td style='padding-left:4ex; text-align: right;'>-0.349600</td>
<td style='padding-left:4ex; text-align: right;'> 0.35220</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 5.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.331800</td>
<td style='padding-left:4ex; text-align: right;'>0.18660</td>
<td style='padding-left:4ex; text-align: right;'>-0.699800</td>
<td style='padding-left:4ex; text-align: right;'> 0.03611</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 6.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.298500</td>
<td style='padding-left:4ex; text-align: right;'>0.18380</td>
<td style='padding-left:4ex; text-align: right;'>-0.661000</td>
<td style='padding-left:4ex; text-align: right;'> 0.06398</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 7.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.065230</td>
<td style='padding-left:4ex; text-align: right;'>0.25170</td>
<td style='padding-left:4ex; text-align: right;'>-0.431000</td>
<td style='padding-left:4ex; text-align: right;'> 0.56150</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 8.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.369200</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.28170</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.186300</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.92470</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Isoleucine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Isoleucine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Isoleucine reference value of ", round(ddIsoleucine_refit$limits["Isoleucine"][2,]), " μmol/g (median)"), nb = 14)
```

## Model - 3rd Pass

The 2nd pass model uses too many degrees of freedom (df) in relation to the size of the data i.e. 14 df should be spent instead of the 16 from the model. This can be seen by conducting a validation and calibration analysis. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Isoleucine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.19</td>
<td style='padding-left:3ex; text-align: center;'>0.06</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>294</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>0.26</td>
<td style='padding-left:3ex; text-align: center;'>0.3</td>
<td style='padding-left:3ex; text-align: center;'>-0.04</td>
<td style='padding-left:3ex; text-align: center;'>0.32</td>
<td style='padding-left:3ex; text-align: center;'>294</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.23</td>
<td style='padding-left:3ex; text-align: center;'>0.27</td>
<td style='padding-left:3ex; text-align: center;'>0.18</td>
<td style='padding-left:3ex; text-align: center;'>0.09</td>
<td style='padding-left:3ex; text-align: center;'>0.14</td>
<td style='padding-left:3ex; text-align: center;'>294</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.82</td>
<td style='padding-left:3ex; text-align: center;'>-0.82</td>
<td style='padding-left:3ex; text-align: center;'>0.82</td>
<td style='padding-left:3ex; text-align: center;'>294</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.68</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.32</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.68</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>294</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

From this table it can be seen that the optimism statistic which indicates the extent of model overfitting, for a variety of performance metrics has values that are large. Thus overfitting is present in the model. 

By calibrating the predicted values from the model to the observed ones, we also notice a good amount of deviation from the diagonal line (ideal model performance) after correcting for this overfitting or bias. 

```{r}
#| label: fig-Isoleucine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Isoleucine_mod_refit_cal)
```

The 2nd pass model also includes the chronic_disease_v3 variable which contains categories with low frequencies in the data. As a result the effect size estimate is accompanied by a very large confidence interval. This renders the estimate as non-trustworthy.  

From these results and also the variable importance plot seen previously as well as the analysis of variance results, it looks like the variables, bmi, age and sex can be kept in a new model with less degree of freedom spending i.e. less overfitting the data. 

Hence the model is refitted to the data with these just 3 covariates (Note: Situation might change when more data are collected and the model is refit).

The model formula is: 

`log(Isoleucine) ~ sex + rcs(age,4) + bmi + sex:rcs(age,4)`

and in expanded form:

```{r}
noquote(reg_f_Isoleucine_refit2)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddIsoleucine_refit  
```

### Residuals

```{r}
#| label: fig-Isoleucine-refit2-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers. Here the algorithm reports outliers due to its parameterization, however these are weak outliers since their deviation from the straight line is not large." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Isoleucine_mod_refit2$outliersPlot
```

```{r}
#| label: fig-Isoleucine-refit2-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Isoleucine_mod_refit2), resid_Isoleucine_mod_refit2, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Isoleucine-refit2-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Isoleucine_mod_refit2), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 4, nx = NA, col = "black")
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Isoleucine_mod_refit2 
# eval=FALSE after html copy-pasting below
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Isoleucine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.0</td>
<td style='padding-left:4ex; text-align: right;'>53.0</td>
<td style='padding-left:4ex; text-align: right;'>19.0</td>
<td style='padding-left:4ex; text-align: right;'> 0.11860</td>
<td style='padding-left:4ex; text-align: right;'>0.14110</td>
<td style='padding-left:4ex; text-align: right;'>-0.159700</td>
<td style='padding-left:4ex; text-align: right;'> 0.3968</td>
</tr>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.8</td>
<td style='padding-left:4ex; text-align: right;'>29.3</td>
<td style='padding-left:4ex; text-align: right;'> 6.5</td>
<td style='padding-left:4ex; text-align: right;'> 0.09597</td>
<td style='padding-left:4ex; text-align: right;'>0.04919</td>
<td style='padding-left:4ex; text-align: right;'>-0.001017</td>
<td style='padding-left:4ex; text-align: right;'> 0.1930</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 2.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.31670</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.10470</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.523200</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.1102</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Isoleucine-refit2-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Isoleucine_mod_refit2, digits = 1, log = TRUE, main = paste0("% increase/decrease on Isoleucine reference value of ", round(ddIsoleucine_refit$limits["Isoleucine"][2,]), " μmol/g (median)"), nb = 4) # nb = 4 reduces the spacing between the CIs, looks better without it on the site
```

### Partial Dependence Plots

```{r}
#| label: fig-Isoleucine-refit2-var-partial-effects-plot1
#| fig-cap: "Linear effect of bmi. Isoleucine concentration levels can be seen to increase with increasing bmi." 
#| fig-width: 8  

ggplot(Predict(Isoleucine_mod_refit2, bmi, fun = exp))
```

```{r}
#| label: fig-Isoleucine-refit2-var-partial-effects-plot2
#| fig-cap: "Nonlinear effect of age. Age is seen to decrease the levels of Isoleucine concentration particularly for the below 30 and above 60 years subgroups."
#| fig-width: 8 

ggplot(Predict(Isoleucine_mod_refit2, age, fun = exp))
```

```{r}
#| label: fig-Isoleucine-refit2-var-partial-effects-plot3
#| fig-cap: "Effect of sex. Females have higher levels of Isoleucine concentration."
#| fig-width: 8 

ggplot(Predict(Isoleucine_mod_refit2, sex, fun = exp))
```

```{r}
#| label: fig-Isoleucine-refit2-var-partial-effects-plot4
#| fig-cap: "Simultaneous effects of bmi and age. Isoleucine concentration levels are seen to increase with increasing bmi and decreasing age."
#| fig-width: 8  
  
# pred_intx1_Isoleucine is defined in workspace
bplot(pred_intx1_Isoleucine, yhat ~ age + bmi, lfun = lattice::wireframe, zlab = "Isoleucine\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6)
```

```{r}
#| label: fig-Isoleucine-refit2-var-partial-effects-plot5
#| fig-cap: "Simultaneous effects of sex and age. Males are shown to have higher Isoleucine concentration levels at old age (above 60) compared to females."
#| fig-width: 8  
  
# pred_intx2_Isoleucine is defined in workspace
bplot(pred_intx2_Isoleucine, yhat ~ age + sex, lfun = lattice::wireframe, zlab = "Isoleucine\n",  screen=list(z=150, x=-75), ylabrot = 35, cex.lab = 0.55, cex.adj = 0.6)
```

```{r}
#| label: fig-Isoleucine-refit2-var-partial-effects-plot6
#| fig-cap: "Simultaneous effects of sex and bmi. As the bmi increases, Isoleucine concentration levels increase at a higher level for females than for males."
#| fig-width: 8  
  
# pred_intx3_Isoleucine is defined in workspace
bplot(pred_intx3_Isoleucine, yhat ~ bmi + sex, lfun = lattice::wireframe, zlab = "Isoleucine\n",  screen=list(z=150, x=-75), ylabrot = 35, cex.lab = 0.55, cex.adj = 0.6)
```

### Validation & Calibration 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Isoleucine_mod_refit2_val, digits = 2, caption = "3rd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
3rd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.09</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.05</td>
<td style='padding-left:3ex; text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.01</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.29</td>
<td style='padding-left:3ex; text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>0.3</td>
<td style='padding-left:3ex; text-align: center;'>-0.03</td>
<td style='padding-left:3ex; text-align: center;'>0.31</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.19</td>
<td style='padding-left:3ex; text-align: center;'>0.22</td>
<td style='padding-left:3ex; text-align: center;'>0.16</td>
<td style='padding-left:3ex; text-align: center;'>0.06</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.65</td>
<td style='padding-left:3ex; text-align: center;'>-0.65</td>
<td style='padding-left:3ex; text-align: center;'>0.65</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.75</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.25</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.75</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

We note also that the successful number of resamples is 300 (i.e. the number of bootstrap samples that we have chosen to perform the validation). In contrast, the 2nd pass model did not use all of the 300 resamples due to divergence or singularity issues which occurred in 6 samples, and thus left 294 resamples to use for the validation. These divergence issues were due to reasons such as missing values, categories of the chronic_disease_v3 variable with a low frequency and the complexity of the model.  
In addition this 3rd pass model has used only 215 individuals from the current pool of 308 due the many zero or non-detection cases in the data. 

```{r}
#| label: fig-Isoleucine-refit2-cal
#| fig-cap: "Calibration plot for 3rd pass model. Deviation from the diagonal line after correcting for overfitting or bias. It can be seen that deviations have been reduced compared to the 2nd pass model, especially on the left side where underestimation is the issue. On the right part overestimation can be observed that has not been eliminated in comparison to the 2nd pass model. This is perhaps due to the currently small sample size of 215 individuals upon which the models have been built." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Isoleucine_mod_refit2_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 3rd pass model only bmi, age and sex make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Isoleucine_mod_refit2, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, sex, age, bmi), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))

dynRI
```

The RI for Isoleucine from Mayo Clinic Laboratories for ages above 18 years is less than 22 μmol/g of creatinine.

# Leucine

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Leucine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Leucine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datLeucine, p = 2, na.action = na.omit))
abline(v = c(-0.01/2, 0.01/2), lty = "dashed")
grid(ny = 9, nx = NA, col = "black")
```

Non-linearity evident in chronic_disease_v3, aerobics_activity, resistance_activity, bmi and age (smaller $\rho^2$ with opposite sign). Most $\rho^2$ values are relatively small.

To capture non linearities interactions amongst these 5 variables will be considered, as well as spline transformations. The model achieving the best global significance (p-value = `0.0519`) contained the following terms: 

`log(Leucine) ~ rcs(age,4) + rcs(bmi,4) + log(aerobics_activity+1) + log(resistance_activity+1) + chronic_disease_v3 + rcs(age,4):rcs(bmi,4) + rcs(age,4):log(aerobics_activity+1) + rcs(age,4):log(resistance_activity+1) + rcs(age,4):chronic_disease_v3 + rcs(bmi,4):log(aerobics_activity+1) + rcs(bmi,4):log(resistance_activity+1) + log(aerobics_activity+1):log(resistance_activity+1)`

Where the `:` symbol denotes the interaction between two variables and rcs denotes a restricted cubic spline transformation with 3 knots. 

Since this is a 1st pass for the model, fairly complex and with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 
## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Leucine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()      
DescTools::Desc(resid_Leucine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Leucine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Leucine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Leucine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Leucine_mod$outliersPlot
```

```{r}
gt(out_resid_Leucine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Leucine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Leucine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Leucine
    )
  )
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the strong outlier values detected in the previous step. The model formula is the same as the 1st pass. The global regression significance is characterized by a p-value of `0.0187`. 

### Residuals

```{r}
#| label: fig-Leucine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed weak outliers (the strong ones detected by the 1st pass model have been removed)." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Leucine_mod_refit$outliersPlot
```

```{r}
#| label: fig-Leucine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Leucine_mod_refit), resid_Leucine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Leucine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Leucine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 12, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Leucine_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Leucine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.00</td>
<td style='padding-left:4ex; text-align: right;'> 53.00</td>
<td style='padding-left:4ex; text-align: right;'> 19.00</td>
<td style='padding-left:4ex; text-align: right;'> 0.380400</td>
<td style='padding-left:4ex; text-align: right;'>0.1917</td>
<td style='padding-left:4ex; text-align: right;'> 0.001882</td>
<td style='padding-left:4ex; text-align: right;'>0.7589</td>
</tr>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.78</td>
<td style='padding-left:4ex; text-align: right;'> 29.33</td>
<td style='padding-left:4ex; text-align: right;'>  6.55</td>
<td style='padding-left:4ex; text-align: right;'> 0.020530</td>
<td style='padding-left:4ex; text-align: right;'>0.1388</td>
<td style='padding-left:4ex; text-align: right;'>-0.253600</td>
<td style='padding-left:4ex; text-align: right;'>0.2947</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'> 60.00</td>
<td style='padding-left:4ex; text-align: right;'> 60.00</td>
<td style='padding-left:4ex; text-align: right;'> 0.041220</td>
<td style='padding-left:4ex; text-align: right;'>0.1345</td>
<td style='padding-left:4ex; text-align: right;'>-0.224400</td>
<td style='padding-left:4ex; text-align: right;'>0.3068</td>
</tr>
<tr>
<td style='text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'>450.00</td>
<td style='padding-left:4ex; text-align: right;'>450.00</td>
<td style='padding-left:4ex; text-align: right;'>-0.211600</td>
<td style='padding-left:4ex; text-align: right;'>0.2790</td>
<td style='padding-left:4ex; text-align: right;'>-0.762500</td>
<td style='padding-left:4ex; text-align: right;'>0.3394</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  2.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.001054</td>
<td style='padding-left:4ex; text-align: right;'>0.1462</td>
<td style='padding-left:4ex; text-align: right;'>-0.289800</td>
<td style='padding-left:4ex; text-align: right;'>0.2877</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  3.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.023540</td>
<td style='padding-left:4ex; text-align: right;'>0.1884</td>
<td style='padding-left:4ex; text-align: right;'>-0.395500</td>
<td style='padding-left:4ex; text-align: right;'>0.3484</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  4.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.080100</td>
<td style='padding-left:4ex; text-align: right;'>1.3830</td>
<td style='padding-left:4ex; text-align: right;'>-2.650000</td>
<td style='padding-left:4ex; text-align: right;'>2.8100</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  5.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.378600</td>
<td style='padding-left:4ex; text-align: right;'>0.3634</td>
<td style='padding-left:4ex; text-align: right;'>-0.338900</td>
<td style='padding-left:4ex; text-align: right;'>1.0960</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  6.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.011090</td>
<td style='padding-left:4ex; text-align: right;'>0.3870</td>
<td style='padding-left:4ex; text-align: right;'>-0.753100</td>
<td style='padding-left:4ex; text-align: right;'>0.7752</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; text-align: right;'>  7.00</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.414500</td>
<td style='padding-left:4ex; text-align: right;'>0.4004</td>
<td style='padding-left:4ex; text-align: right;'>-0.376100</td>
<td style='padding-left:4ex; text-align: right;'>1.2050</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>  8.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.881800</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>1.3060</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-1.696000</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>3.4600</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Leucine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Leucine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Leucine reference value of ", round(ddLeucine_refit$limits["Leucine"][2,]), " μmol/g (median)"), nb = 12)
```

## Model - 3rd Pass

The 2nd pass model uses too many degrees of freedom (df) in relation to the size of the data i.e. `15` df should be spent instead of the `59` from the model. This can be seen by conducting a validation and calibration analysis. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Leucine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.31</td>
<td style='padding-left:3ex; text-align: center;'>0.48</td>
<td style='padding-left:3ex; text-align: center;'>-76.58</td>
<td style='padding-left:3ex; text-align: center;'>77.06</td>
<td style='padding-left:3ex; text-align: center;'>-76.75</td>
<td style='padding-left:3ex; text-align: center;'>16</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.17</td>
<td style='padding-left:3ex; text-align: center;'>0.12</td>
<td style='padding-left:3ex; text-align: center;'>18.53</td>
<td style='padding-left:3ex; text-align: center;'>-18.41</td>
<td style='padding-left:3ex; text-align: center;'>18.57</td>
<td style='padding-left:3ex; text-align: center;'>16</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.29</td>
<td style='padding-left:3ex; text-align: center;'>0.37</td>
<td style='padding-left:3ex; text-align: center;'>0.11</td>
<td style='padding-left:3ex; text-align: center;'>0.26</td>
<td style='padding-left:3ex; text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>16</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>2.4</td>
<td style='padding-left:3ex; text-align: center;'>-2.4</td>
<td style='padding-left:3ex; text-align: center;'>2.4</td>
<td style='padding-left:3ex; text-align: center;'>16</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.25</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.75</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.25</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>16</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

From this table it can be seen that the optimism statistic which indicates the extent of model overfitting, for a variety of performance metrics has values that are large. Thus overfitting is present in the model. 

By calibrating the predicted values from the model to the observed ones, we also notice a good amount of deviation from the diagonal line (ideal model performance) after correcting for this overfitting or bias. 

```{r}
#| label: fig-Leucine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Leucine_mod_refit_cal)
```

The 2nd pass model also includes the chronic_disease_v3 variable which contains categories with low frequencies in the data. As a result the effect size estimate is accompanied by a very large confidence interval. This renders the estimate as non-trustworthy.  

From these results and also the variable importance plot seen previously as well as the analysis of variance results, it looks like the variables age and resistance_activity are most important, with perhaps bmi and aerobics_activity included too. These variables can be kept in a new model with less degree of freedom spending i.e. less overfitting the data. 

Hence the model is refitted to the data with these just 4 covariates (Note: Situation might change when more data are collected and the model is refit).

The model formula is: 

`log(Leucine) ~ rcs(age,4) + rcs(bmi,4) + log(resistance_activity+1) + rcs(age,4):log(resistance_activity+1) + log(aerobics_activity+1)`

with a spending of `12` degrees of freedom.

However, when examining the normal probability plot of this model's residuals, the following is observed:

```{r}
#| label: fig-Leucine-refit2-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers. At this stage of the analysis, the algorithm rtypically eports weak outliers due to its parameterization. However, two strong outliers can be seen on the far right of the plot. These are strong because their deviation from the straight line is much larger than the rest of the cases." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Leucine_mod_refit2$outliersPlot
```

There are two more strong outliers that remain. After removing these two data points, the model is then refit, with the same model formula as above and a global significance of `0.0021` (p-value).

The model formula is: 

`log(Leucine) ~ rcs(age,4) + rcs(bmi,4) + log(resistance_activity+1) + rcs(age,4):log(resistance_activity+1) + log(aerobics_activity+1)`

and in expanded form:

```{r}
noquote(reg_f_Leucine_refit3)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddLeucine_refit2  
```

### Residuals

```{r}
#| label: fig-Leucine-refit3-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers. Here the algorithm reports outliers due to its parameterization, however these are weak outliers since their deviation from the straight line is not large." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Leucine_mod_refit3$outliersPlot
```

```{r}
#| label: fig-Leucine-refit3-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Leucine_mod_refit3), resid_Leucine_mod_refit3, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Leucine-refit3-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Leucine_mod_refit3), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 5, nx = NA, col = "black")
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Leucine_mod_refit3
# eval=FALSE after html copy-pasting below
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Leucine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.00</td>
<td style='padding-left:4ex; text-align: right;'> 53.00</td>
<td style='padding-left:4ex; text-align: right;'> 19.00</td>
<td style='padding-left:4ex; text-align: right;'> 0.14750</td>
<td style='padding-left:4ex; text-align: right;'>0.09917</td>
<td style='padding-left:4ex; text-align: right;'>-0.04798</td>
<td style='padding-left:4ex; text-align: right;'> 0.34300</td>
</tr>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.72</td>
<td style='padding-left:4ex; text-align: right;'> 29.37</td>
<td style='padding-left:4ex; text-align: right;'>  6.65</td>
<td style='padding-left:4ex; text-align: right;'> 0.09335</td>
<td style='padding-left:4ex; text-align: right;'>0.08260</td>
<td style='padding-left:4ex; text-align: right;'>-0.06948</td>
<td style='padding-left:4ex; text-align: right;'> 0.25620</td>
</tr>
<tr>
<td style='text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; text-align: right;'>450.00</td>
<td style='padding-left:4ex; text-align: right;'>450.00</td>
<td style='padding-left:4ex; text-align: right;'>-0.29440</td>
<td style='padding-left:4ex; text-align: right;'>0.12950</td>
<td style='padding-left:4ex; text-align: right;'>-0.54970</td>
<td style='padding-left:4ex; text-align: right;'>-0.03909</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 60.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 60.00</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.01490</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.06229</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.10790</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.13770</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Leucine-refit3-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Leucine_mod_refit3, digits = 1, log = TRUE, main = paste0("% increase/decrease on Leucine reference value of ", round(ddLeucine_refit2$limits["Leucine"][2,]), " μmol/g (median)"), nb = 5) # nb = 4 reduces the spacing between the CIs, looks better without it on the site
```

### Partial Dependence Plots

```{r}
#| label: fig-Leucine-refit3-var-partial-effects-plot1
#| fig-cap: "Linear effect of bmi. Leucine concentration levels can be seen to increase with increasing bmi." 
#| fig-width: 8  

ggplot(Predict(Leucine_mod_refit3, bmi, fun = exp))
```

```{r}
#| label: fig-Leucine-refit3-var-partial-effects-plot2
#| fig-cap: "Nonlinear effect of age. Age is seen to decrease the levels of Leucine concentration particularly for the below 30 years subgroup."
#| fig-width: 8 

ggplot(Predict(Leucine_mod_refit3, age, fun = exp))
```

```{r}
#| label: fig-Leucine-refit3-var-partial-effects-plot3
#| fig-cap: "Effect of resistance training. Leucine concentration decreases with increasing weekly duration of resistance training."
#| fig-width: 8 

ggplot(Predict(Leucine_mod_refit3, resistance_activity, fun = exp))
```

```{r}
#| label: fig-Leucine-refit3-var-partial-effects-plot4
#| fig-cap: "No particular effect of aerobics training on levels of Leucine concentration."
#| fig-width: 8 

ggplot(Predict(Leucine_mod_refit3, aerobics_activity, fun = exp))
```

```{r}
#| label: fig-Leucine-refit3-var-partial-effects-plot5
#| fig-cap: "Simultaneous effects of age and resistance_activity. Leucine concentration levels are seen to increase with increasing both age and weekly resistance training duration."
#| fig-width: 8  
  
# pred_intx1_Leucine is defined in workspace
bplot(pred_intx1_Leucine, yhat ~ age + resistance_activity, lfun = lattice::wireframe, zlab = "Leucine\n",  screen=list(z=120, x=-75), ylabrot = 12, cex.lab = 0.55, cex.adj = 0.6)
```

```{r}
#| label: fig-Leucine-refit3-var-partial-effects-plot6
#| fig-cap: "Simultaneous effects of age and bmi. Leucine concentration levels are seen to increase with decreasing age and increasing bmi."
#| fig-width: 8  
  
# pred_intx2_Leucine is defined in workspace
bplot(pred_intx2_Leucine, yhat ~ age + bmi, lfun = lattice::wireframe, zlab = "Leucine\n",  screen=list(z=150, x=-75), ylabrot = 35, cex.lab = 0.55, cex.adj = 0.6)
```

```{r}
#| label: fig-Leucine-refit3-var-partial-effects-plot7
#| fig-cap: "Simultaneous effects of bmi and resistance_activity. Leucine concentration levels are seen to increase with increasing bmi and decreasing weekly resistance training duration."
#| fig-width: 8  
  
# pred_intx3_Leucine is defined in workspace
bplot(pred_intx3_Leucine, yhat ~ bmi + resistance_activity, lfun = lattice::wireframe, zlab = "Leucine\n",  screen=list(z=120, x=-75), xlabrot = -35, ylabrot = 15, cex.lab = 0.55, cex.adj = 0.6)
```

### Validation & Calibration 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Leucine_mod_refit3_val, digits = 2, caption = "3rd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
3rd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.12</td>
<td style='padding-left:3ex; text-align: center;'>0.16</td>
<td style='padding-left:3ex; text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.2</td>
<td style='padding-left:3ex; text-align: center;'>0.19</td>
<td style='padding-left:3ex; text-align: center;'>0.21</td>
<td style='padding-left:3ex; text-align: center;'>-0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.22</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.18</td>
<td style='padding-left:3ex; text-align: center;'>0.21</td>
<td style='padding-left:3ex; text-align: center;'>0.16</td>
<td style='padding-left:3ex; text-align: center;'>0.05</td>
<td style='padding-left:3ex; text-align: center;'>0.14</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.72</td>
<td style='padding-left:3ex; text-align: center;'>-0.72</td>
<td style='padding-left:3ex; text-align: center;'>0.72</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.77</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.23</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.77</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

We note also that the successful number of resamples is 300 (i.e. the number of bootstrap samples that we have chosen to perform the validation). In contrast, the 2nd pass model did not use all of the 300 resamples due to divergence or singularity issues which occurred in 284 samples, and thus left only 16 resamples to use for the validation. These divergence issues were due to reasons such as missing values, categories of the chronic_disease_v3 variable with a low frequency and the complexity of the model.  
In addition this 3rd pass model has used only 222 individuals from the current pool of 308 due the many zero or non-detection cases in the data. 

```{r}
#| label: fig-Leucine-refit3-cal
#| fig-cap: "Calibration plot for 3rd pass model. Deviation from the diagonal line after correcting for overfitting or bias. It can be seen that deviations have been reduced compared to the 2nd pass model, especially on the right side where overestimation is the issue. On the central-left part (between 2.9 and 3.1 predicted log scale) some underestimation can be observed that has not been eliminated in comparison to the 2nd pass model. This is perhaps due to the currently small sample size of 222 individuals upon which the model has been built." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Leucine_mod_refit3_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 3rd pass model only age, bmi, resistance_activity and aerobics_activity make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Leucine_mod_refit3, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, age, bmi, resistance_activity, aerobics_activity), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))

dynRI
```

The RI for Leucine from Mayo Clinic Laboratories for ages above 18 years is less than 51 μmol/g of creatinine.

# Glutamine

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Glutamine-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Glutamine ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datGlutamine, p = 2, na.action = na.omit))
abline(v = c(-0.01/2, 0.01/2), lty = "dashed")
grid(ny = 9, nx = NA, col = "black")
```

Non-linearity evident in in chronic_disease_v3, resistance_activity, sex, bmi (smaller $\rho^2$ with opposite sign) and age (smaller $\rho^2$ with opposite sign). Most $\rho^2$ values are relatively small.

To capture non linearities interactions amongst these 5 variables will be considered, as well as spline transformations. The model achieving the best global significance (p-value = `0.0388`) contained the following terms: 

`log(Glutamine) ~ sex + chronic_disease_v3 + log(resistance_activity+1) + rcs(bmi,4) + rcs(age,4) + sex:log(resistance_activity+1) + sex:rcs(bmi,4) + sex:rcs(age,4) + chronic_disease_v3:log(resistance_activity+1)`

Where the `:` symbol denotes the interaction between two variables and rcs denotes a restricted cubic spline transformation with 3 knots. 

Since this is a 1st pass for the model, fairly complex and with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 
## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Glutamine-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()      
DescTools::Desc(resid_Glutamine_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Glutamine Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Glutamine-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Glutamine-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glutamine_mod$outliersPlot
```

```{r}
gt(out_resid_Glutamine_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Glutamine) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Glutamine)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Glutamine
    )
  )
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the strong outlier values detected in the previous step. The model formula is the same as the 1st pass. The global regression significance is characterized by a p-value of `0.0038`. 

### Residuals

```{r}
#| label: fig-Glutamine-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed weak outliers (the strong ones detected by the 1st pass model have been removed)." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glutamine_mod_refit$outliersPlot
```

```{r}
#| label: fig-Glutamine-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Glutamine_mod_refit), resid_Glutamine_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Glutamine-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Glutamine_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 9, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Glutamine_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Glutamine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.0</td>
<td style='padding-left:4ex; text-align: right;'>450.0</td>
<td style='padding-left:4ex; text-align: right;'>450.0</td>
<td style='padding-left:4ex; text-align: right;'>-0.07761</td>
<td style='padding-left:4ex; text-align: right;'>0.1810</td>
<td style='padding-left:4ex; text-align: right;'>-0.43470</td>
<td style='padding-left:4ex; text-align: right;'> 0.27950</td>
</tr>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.8</td>
<td style='padding-left:4ex; text-align: right;'> 29.4</td>
<td style='padding-left:4ex; text-align: right;'>  6.6</td>
<td style='padding-left:4ex; text-align: right;'>-0.07617</td>
<td style='padding-left:4ex; text-align: right;'>0.1355</td>
<td style='padding-left:4ex; text-align: right;'>-0.34340</td>
<td style='padding-left:4ex; text-align: right;'> 0.19110</td>
</tr>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.0</td>
<td style='padding-left:4ex; text-align: right;'> 53.0</td>
<td style='padding-left:4ex; text-align: right;'> 19.0</td>
<td style='padding-left:4ex; text-align: right;'>-0.12080</td>
<td style='padding-left:4ex; text-align: right;'>0.1464</td>
<td style='padding-left:4ex; text-align: right;'>-0.40960</td>
<td style='padding-left:4ex; text-align: right;'> 0.16810</td>
</tr>
<tr>
<td style='text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'>  2.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.35600</td>
<td style='padding-left:4ex; text-align: right;'>0.1450</td>
<td style='padding-left:4ex; text-align: right;'>-0.64210</td>
<td style='padding-left:4ex; text-align: right;'>-0.06998</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'>  2.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.32920</td>
<td style='padding-left:4ex; text-align: right;'>0.1393</td>
<td style='padding-left:4ex; text-align: right;'> 0.05442</td>
<td style='padding-left:4ex; text-align: right;'> 0.60410</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'>  3.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.35000</td>
<td style='padding-left:4ex; text-align: right;'>0.1591</td>
<td style='padding-left:4ex; text-align: right;'> 0.03614</td>
<td style='padding-left:4ex; text-align: right;'> 0.66380</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'>  4.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.31670</td>
<td style='padding-left:4ex; text-align: right;'>0.2042</td>
<td style='padding-left:4ex; text-align: right;'>-0.08614</td>
<td style='padding-left:4ex; text-align: right;'> 0.71960</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'>  5.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.40540</td>
<td style='padding-left:4ex; text-align: right;'>0.2390</td>
<td style='padding-left:4ex; text-align: right;'>-0.06618</td>
<td style='padding-left:4ex; text-align: right;'> 0.87710</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'>  6.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.31300</td>
<td style='padding-left:4ex; text-align: right;'>0.2546</td>
<td style='padding-left:4ex; text-align: right;'>-0.18940</td>
<td style='padding-left:4ex; text-align: right;'> 0.81540</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'>  7.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.13910</td>
<td style='padding-left:4ex; text-align: right;'>0.2821</td>
<td style='padding-left:4ex; text-align: right;'>-0.69570</td>
<td style='padding-left:4ex; text-align: right;'> 0.41740</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>  8.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.69030</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.5430</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.38110</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.76200</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Glutamine-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Glutamine_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Glutamine reference value of ", round(ddGlutamine_refit$limits["Glutamine"][2,]), " μmol/g (median)"), nb = 12)
```

## Model - 3rd Pass

The 2nd pass model uses too many degrees of freedom (df) in relation to the size of the data i.e. `14` df should be spent instead of the `30` from the model. This can be seen by conducting a validation and calibration analysis. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Glutamine_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.22</td>
<td style='padding-left:3ex; text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>0.07</td>
<td style='padding-left:3ex; text-align: center;'>0.26</td>
<td style='padding-left:3ex; text-align: center;'>-0.03</td>
<td style='padding-left:3ex; text-align: center;'>142</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.25</td>
<td style='padding-left:3ex; text-align: center;'>0.22</td>
<td style='padding-left:3ex; text-align: center;'>0.3</td>
<td style='padding-left:3ex; text-align: center;'>-0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.33</td>
<td style='padding-left:3ex; text-align: center;'>142</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.29</td>
<td style='padding-left:3ex; text-align: center;'>0.36</td>
<td style='padding-left:3ex; text-align: center;'>0.23</td>
<td style='padding-left:3ex; text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.16</td>
<td style='padding-left:3ex; text-align: center;'>142</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>2.1</td>
<td style='padding-left:3ex; text-align: center;'>-2.1</td>
<td style='padding-left:3ex; text-align: center;'>2.1</td>
<td style='padding-left:3ex; text-align: center;'>142</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.64</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.36</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.64</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>142</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

From this table it can be seen that the optimism statistic which indicates the extent of model overfitting, for a variety of performance metrics has values that are large. Thus overfitting is present in the model. 

By calibrating the predicted values from the model to the observed ones, we also notice a good amount of deviation from the diagonal line (ideal model performance) after correcting for this overfitting or bias. 

```{r}
#| label: fig-Glutamine-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Glutamine_mod_refit_cal)
```

The 2nd pass model also includes the chronic_disease_v3 variable which contains categories with low frequencies in the data. As a result the effect size estimate is accompanied by a very large confidence interval. This renders the estimate as non-trustworthy.  

From these results and also the variable importance plot seen previously as well as the analysis of variance results, it looks like the variables sex and chronic_disease_v3 are most important, with perhaps age, bmi and resistance_activity included too. These variables can be kept in a new model with less degree of freedom spending i.e. less overfitting the data. 

Hence the model is refitted to the data including various combinations of these 5 covariates, with the chosen model spending just `13` degrees of freedom and having a global p-value equal to `0.0006`.(Note: Situation might change when more data are collected and the model is refit).

The chosen model formula is: 

`log(Glutamine) ~ sex + chronic_disease_v3 + log(resistance_activity+1)+ rcs(age,4)`

and in expanded form:

```{r}
noquote(reg_f_Glutamine_refit2)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddGlutamine_refit 
```

### Residuals

```{r}
#| label: fig-Glutamine-refit2-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers. Here the algorithm does not report any weak outliers due to its parameterization i.e. outliers whose deviation from the straight line is not large." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glutamine_mod_refit2$outliersPlot
```

```{r}
#| label: fig-Glutamine-refit2-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Glutamine_mod_refit2), resid_Glutamine_mod_refit2, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Glutamine-refit2-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Glutamine_mod_refit2), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 4, nx = NA, col = "black")
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Glutamine_mod_refit2
# eval=FALSE after html copy-pasting below
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Glutamine)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>resistance_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0</td>
<td style='padding-left:4ex; text-align: right;'>450</td>
<td style='padding-left:4ex; text-align: right;'>450</td>
<td style='padding-left:4ex; text-align: right;'>-0.28950</td>
<td style='padding-left:4ex; text-align: right;'>0.10360</td>
<td style='padding-left:4ex; text-align: right;'>-0.49370</td>
<td style='padding-left:4ex; text-align: right;'>-0.08533</td>
</tr>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34</td>
<td style='padding-left:4ex; text-align: right;'> 53</td>
<td style='padding-left:4ex; text-align: right;'> 19</td>
<td style='padding-left:4ex; text-align: right;'>-0.02972</td>
<td style='padding-left:4ex; text-align: right;'>0.10370</td>
<td style='padding-left:4ex; text-align: right;'>-0.23410</td>
<td style='padding-left:4ex; text-align: right;'> 0.17470</td>
</tr>
<tr>
<td style='text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; text-align: right;'> 1</td>
<td style='padding-left:4ex; text-align: right;'>  2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.19210</td>
<td style='padding-left:4ex; text-align: right;'>0.07711</td>
<td style='padding-left:4ex; text-align: right;'>-0.34400</td>
<td style='padding-left:4ex; text-align: right;'>-0.04018</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1</td>
<td style='padding-left:4ex; text-align: right;'>  2</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.15390</td>
<td style='padding-left:4ex; text-align: right;'>0.11130</td>
<td style='padding-left:4ex; text-align: right;'>-0.06547</td>
<td style='padding-left:4ex; text-align: right;'> 0.37320</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1</td>
<td style='padding-left:4ex; text-align: right;'>  3</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.19690</td>
<td style='padding-left:4ex; text-align: right;'>0.12370</td>
<td style='padding-left:4ex; text-align: right;'>-0.04678</td>
<td style='padding-left:4ex; text-align: right;'> 0.44050</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1</td>
<td style='padding-left:4ex; text-align: right;'>  4</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.30080</td>
<td style='padding-left:4ex; text-align: right;'>0.17180</td>
<td style='padding-left:4ex; text-align: right;'>-0.03767</td>
<td style='padding-left:4ex; text-align: right;'> 0.63920</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1</td>
<td style='padding-left:4ex; text-align: right;'>  5</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.04866</td>
<td style='padding-left:4ex; text-align: right;'>0.16730</td>
<td style='padding-left:4ex; text-align: right;'>-0.28090</td>
<td style='padding-left:4ex; text-align: right;'> 0.37830</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1</td>
<td style='padding-left:4ex; text-align: right;'>  6</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.16760</td>
<td style='padding-left:4ex; text-align: right;'>0.17610</td>
<td style='padding-left:4ex; text-align: right;'>-0.17940</td>
<td style='padding-left:4ex; text-align: right;'> 0.51460</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1</td>
<td style='padding-left:4ex; text-align: right;'>  7</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.53210</td>
<td style='padding-left:4ex; text-align: right;'>0.20250</td>
<td style='padding-left:4ex; text-align: right;'>-0.93120</td>
<td style='padding-left:4ex; text-align: right;'>-0.13310</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>  8</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.28340</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.23540</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.74720</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 0.18040</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Glutamine-refit2-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Glutamine_mod_refit2, digits = 1, log = TRUE, main = paste0("% increase/decrease on Glutamine reference value of ", round(ddGlutamine_refit$limits["Glutamine"][2,]), " μmol/g (median)")) # nb = 4 reduces the spacing between the CIs, looks better without it on the site
```

### Partial Dependence Plots

```{r}
#| label: fig-Glutamine-refit2-var-partial-effects-plot1
#| fig-cap: "Effect of sex. Glutamine concentration levels can be seen to be lower in females than in males." 
#| fig-width: 8  

ggplot(Predict(Glutamine_mod_refit2, sex, fun = exp))
```

```{r}
#| label: fig-Glutamine-refit2-var-partial-effects-plot2
#| fig-cap: "Nonlinear effect of age. Age is seen to decrease the levels of Glutamine concentration particularly for the higher than 60 years subgroup."
#| fig-width: 8 

ggplot(Predict(Glutamine_mod_refit2, age, fun = exp))
```

```{r}
#| label: fig-Glutamine-refit2-var-partial-effects-plot3
#| fig-cap: "Effect of resistance training. Glutamine concentration decreases with increasing weekly duration of resistance training."
#| fig-width: 8 

ggplot(Predict(Glutamine_mod_refit2, resistance_activity, fun = exp))
```

```{r}
#| label: fig-Glutamine-refit2-var-partial-effects-plot4
#| fig-cap: "Effects of chronic disease type. No particular effect of aerobics training on levels of Glutamine concentration."
#| fig-width: 8 
#| fig-height: 12 

ggplot(Predict(Glutamine_mod_refit2, chronic_disease_v3, fun = exp))
```

```{r}
#| label: fig-Glutamine-refit2-var-partial-effects-plot5
#| fig-cap: "Simultaneous effects of age and resistance_activity. Glutamine concentration levels are seen to increase with decreasing both age and weekly resistance training duration."
#| fig-width: 8  
  
# pred_intx1_Glutamine is defined in workspace
bplot(pred_intx1_Glutamine, yhat ~ age + resistance_activity, lfun = lattice::wireframe, zlab = "Glutamine\n",  screen=list(z=-120, x=-75), cex.lab = 0.55, cex.adj = 0.6)
```

```{r}
#| label: fig-Glutamine-refit2-var-partial-effects-plot6
#| fig-cap: "Simultaneous effects of age and sex. Glutamine concentration levels are seen to increase with decreasing age, and being higher for females than for males."
#| fig-width: 8  
  
# pred_intx2_Glutamine is defined in workspace
bplot(pred_intx2_Glutamine, yhat ~ age + sex, lfun = lattice::wireframe, zlab = "Glutamine\n",  screen=list(z=170, x=-75), ylabrot = 70, cex.lab = 0.55, cex.adj = 0.6)
```

```{r}
#| label: fig-Glutamine-refit2-var-partial-effects-plot7
#| fig-cap: "Simultaneous effects of sex and resistance_activity. Glutamine concentration levels are seen to increase with decreasing duration of weekly resistance training, and being higher for females than for males."
#| fig-width: 8  
  
# pred_intx3_Glutamine is defined in workspace
bplot(pred_intx3_Glutamine, yhat ~ sex + resistance_activity, lfun = lattice::wireframe, zlab = "Glutamine\n",  screen=list(z=-120, x=-75), cex.lab = 0.55, cex.adj = 0.6)
```

```{r}
#| label: fig-Glutamine-refit2-var-partial-effects-plot8
#| fig-cap: "Simultaneous effects of sex and chronic diseases. Blood type diseases have the highest Glutamine concentration, and with higher levels for females than for males."
#| fig-width: 8  
  
# pred_intx4_Glutamine is defined in workspace
bplot(pred_intx4_Glutamine, yhat ~ sex + chronic_disease_v3, lfun = lattice::wireframe, zlab = "Glutamine\n",  screen=list(z=300, x=-75), cex.lab = 0.55, cex.adj = 0.6)
```

### Validation & Calibration 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Glutamine_mod_refit2_val, digits = 2, caption = "3rd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
3rd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.17</td>
<td style='padding-left:3ex; text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.09</td>
<td style='padding-left:3ex; text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>299</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.29</td>
<td style='padding-left:3ex; text-align: center;'>0.28</td>
<td style='padding-left:3ex; text-align: center;'>0.31</td>
<td style='padding-left:3ex; text-align: center;'>-0.03</td>
<td style='padding-left:3ex; text-align: center;'>0.32</td>
<td style='padding-left:3ex; text-align: center;'>299</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.23</td>
<td style='padding-left:3ex; text-align: center;'>0.26</td>
<td style='padding-left:3ex; text-align: center;'>0.2</td>
<td style='padding-left:3ex; text-align: center;'>0.06</td>
<td style='padding-left:3ex; text-align: center;'>0.17</td>
<td style='padding-left:3ex; text-align: center;'>299</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>1.32</td>
<td style='padding-left:3ex; text-align: center;'>-1.32</td>
<td style='padding-left:3ex; text-align: center;'>1.32</td>
<td style='padding-left:3ex; text-align: center;'>299</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.77</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.23</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.77</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>299</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

We note also that the successful number of resamples is 299 (i.e. the number of bootstrap samples that we have chosen to perform the validation). In contrast, the 2nd pass model did not use as many resamples due to divergence or singularity issues which occurred in `r nrow(datGlutamine_refit) - 142` samples, and thus left only 142 resamples to use for the validation. These divergence issues were due to reasons such as missing values, categories of the chronic_disease_v3 variable with a low frequency and the complexity of the model.  
In addition this 3rd pass model has used only 245 individuals from the current pool of `r nrow(datGlutamine_refit)` due the many zero or non-detection cases in the data. 

```{r}
#| label: fig-Glutamine-refit2-cal
#| fig-cap: "Calibration plot for 3rd pass model. Deviation from the diagonal line after correcting for overfitting or bias. It can be seen that deviations have been reduced compared to the 2nd pass model, especially on the left side where underestimation is the issue. On the right part (above the value of 6 on the predicted log scale) some overestimation can be observed that has not been eliminated in comparison to the 2nd pass model. This is perhaps due to the currently small sample size of 245 individuals upon which the model has been built." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Glutamine_mod_refit2_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 3rd pass model only age, sex, resistance_activity and chronic_disease_v3 make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Glutamine_mod_refit2, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, age, sex, resistance_activity, chronic_disease_v3) |> rename(resistance = resistance_activity), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))

dynRI  
```

The RI for Glutamine from Mayo Clinic Laboratories for ages above 18 years is between 93 and 1290 μmol/g of creatinine.

# Glutamate

## Model - 1st Pass

Test for non-linear relationships between each covariate and the amino acid concentration is executed below. This helps in deciding whether to model an association in a non-linear fashion i.e. with a polynomial term or a spline term or an interaction, or to just consider the covariates separately and without any special transformation. 

```{r}
#| label: fig-Glutamate-nonlinearities 
#| fig-cap: "Spearman's test for assessing non-linear relationships with the response. The further away from 0 the adjusted $\\rho^2$ score is, the higher the degree of non-linearity for that covariate." 
plot(spearman2(Glutamate ~ sex + age + bmi + chronic_disease_flag + chronic_disease_v3 + meds_flag + supplements_flag + aerobics_activity + resistance_activity, data = datGlutamate, p = 2, na.action = na.omit))
abline(v = c(-0.01/2, 0.01/2), lty = "dashed")
grid(ny = 9, nx = NA, col = "black")
```

Non-linearity evident in in chronic_disease_v3, resistance_activity, sex, bmi (smaller $\rho^2$ with opposite sign) and age (smaller $\rho^2$ with opposite sign). Most $\rho^2$ values are relatively small.

Non-linearity evident in chronic_disease_v3 (smaller $\rho^2$ with opposite sign), sex, bmi (smaller $\rho^2$), age (smaller $\rho^2$ with opposite sign) and aerobics_activity (smaller $\rho^2$ with opposite sign).

To capture non linearities interactions amongst these 5 variables will be considered, as well as spline transformations. The model achieving the best global significance (p-value = `0.0216`) contained the following terms: 

`log(Glutamate) ~ sex + chronic_disease_v3 + rcs(bmi,3) + rcs(age,4) + log(aerobics_activity+1) + sex:rcs(bmi,3) + sex:log(aerobics_activity+1) + rcs(bmi,3):rcs(age,4) + rcs(age,4):log(aerobics_activity+1)`

Where the `:` symbol denotes the interaction between two variables and rcs denotes a restricted cubic spline transformation with 3 or 4 knots. 

Since this is a 1st pass for the model, fairly complex and with a view to detect outliers, more details and characteristics of the model are shown below when the 2nd pass is undertaken. 
## Outlier analysis based on model residuals

When assessing the residuals from the model fit using a normal probability plot, we see the presence of large residuals i.e. difference of the observed and predicted values. These residuals correspond to model predictions that produced larger errors than the bulk of the data. They are indicative of cases that can't be explained well by the model (i.e. missing covariate information, prediction extrapolation from unseen by the model covariate values etc), and as such can be cast as outliers. 
This is also appropriate in terms of developing a model that will be used for reference interval construction i.e. cases foreign to the model should fall outside the reference interval and flagged both as inconclusive and for further inspection. 

```{r}
#| label: fig-Glutamate-resid-1stpass 
#| fig-cap: "Figure combining a histogram with a density plot, a boxplot and the plot of the empirical distribution function (ECDF). The scale for the x-axis is synchronized over all plots. The median can be found on the boxplot as also in the ecdf-plot. The maximum and the minimum value are tagged with a tiny vertical dash upon the ecdf-line. The mean is shown in the boxplot as grey cross, the grey bar is its confidence interval." 

thematic::thematic_off()      
DescTools::Desc(resid_Glutamate_mod, plotit = TRUE, digits = 2, main = "Residual Distribution - Glutamate Model")
```

In comparison to the previous outlier analysis as seen [here](https://drive.google.com/file/d/1oJFw9-542I8KJnnaQdFjSxOrhZqxV7fA/view?usp=drive_link), the difference now is that the analysis is conducted on the model residuals, hence on values that are conditional on meta data (predictor variables) whereas previously the analysis was marginally or unconditionally executed with the only assumption being that of the amino acid concentration following a log-normal distribution. 

@fig-Glutamate-outliers shows a quantile-quantile plot where the quantiles of the model's residual values are matched to the ones predicted from a normal distribution. The diagonal line indicates the ideal fit. Data points marked in red denote outliers (also indicated in the table below each plot with their corresponding subject IDs). 

For the rest of the figures below (i.e. for other amino acids), the same outlier detection procedure is applied but with a different parameterization which controls the outlier detection thresholds (i.e. horizontal lines in plot). 

```{r}
#| label: fig-Glutamate-outliers 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers." 

# thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glutamate_mod$outliersPlot
```

```{r}
gt(out_resid_Glutamate_mod$outliers) |> 
  tab_header(
    title = md("**Outliers**")
  ) |>  
  fmt_number(columns = Glutamate) |> 
  tab_footnote(
    footnote = "Red coloured data points in above QQ plot",
    locations = cells_column_labels(columns = id)
  ) |> 
  tab_footnote(
    footnote = "μmol/g (model residual)",
    locations = cells_column_labels(columns = Glutamate)
  ) |> 
  tab_options(table.background.color = "lavenderblush3", 
              table.font.size = "12px", 
              table.font.style = "oblique") |> 
  tab_style(
    style = list(
      cell_text(color = "red")
      ),
    locations = cells_body(
      columns = Glutamate
    )
  )
```

## Model - 2nd Pass

Here the model is refitted to the data excluding the strong outlier values detected in the previous step. The model formula is the same as the 1st pass. The global regression significance is characterized by a p-value of `0.0027`. 

### Residuals

```{r}
#| label: fig-Glutamate-refit-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed weak outliers (the strong ones detected by the 1st pass model have been removed)." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glutamate_mod_refit$outliersPlot
```

```{r}
#| label: fig-Glutamate-refit-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. No obvious patterns can be seen." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Glutamate_mod_refit), resid_Glutamate_mod_refit, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Glutamate-refit-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Glutamate_mod_refit), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 9, nx = NA, col = "black")
# main = expression(paste("Proportion of overall model ", R^2, " that is due to each predictor"))
# https://library.virginia.edu/data/articles/mathematical-annotation-in-r
# With margin = "partial R2" I believe if you add up all main effect partial R2s and then subtract all interaction effect partial R2s, you get the total R2 as printed from the model object. 
# ALso the sort does not match with the margin...
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Glutamate_mod_refit 
# copy-paste HTML then eval=FALSE in chunk setttings
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Glutamate)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.8</td>
<td style='padding-left:4ex; text-align: right;'>29.3</td>
<td style='padding-left:4ex; text-align: right;'> 6.5</td>
<td style='padding-left:4ex; text-align: right;'>-0.186300</td>
<td style='padding-left:4ex; text-align: right;'>0.1183</td>
<td style='padding-left:4ex; text-align: right;'>-0.4197</td>
<td style='padding-left:4ex; text-align: right;'>0.04722</td>
</tr>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.0</td>
<td style='padding-left:4ex; text-align: right;'>53.0</td>
<td style='padding-left:4ex; text-align: right;'>19.0</td>
<td style='padding-left:4ex; text-align: right;'> 0.158800</td>
<td style='padding-left:4ex; text-align: right;'>0.2266</td>
<td style='padding-left:4ex; text-align: right;'>-0.2881</td>
<td style='padding-left:4ex; text-align: right;'>0.60580</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.0</td>
<td style='padding-left:4ex; text-align: right;'>60.0</td>
<td style='padding-left:4ex; text-align: right;'>60.0</td>
<td style='padding-left:4ex; text-align: right;'>-0.061510</td>
<td style='padding-left:4ex; text-align: right;'>0.1381</td>
<td style='padding-left:4ex; text-align: right;'>-0.3339</td>
<td style='padding-left:4ex; text-align: right;'>0.21090</td>
</tr>
<tr>
<td style='text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 2.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.102000</td>
<td style='padding-left:4ex; text-align: right;'>0.1590</td>
<td style='padding-left:4ex; text-align: right;'>-0.4156</td>
<td style='padding-left:4ex; text-align: right;'>0.21160</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Thyroidism:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 2.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.104300</td>
<td style='padding-left:4ex; text-align: right;'>0.1575</td>
<td style='padding-left:4ex; text-align: right;'>-0.4150</td>
<td style='padding-left:4ex; text-align: right;'>0.20630</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Other:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 3.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.224500</td>
<td style='padding-left:4ex; text-align: right;'>0.1850</td>
<td style='padding-left:4ex; text-align: right;'>-0.1404</td>
<td style='padding-left:4ex; text-align: right;'>0.58940</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Blood:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 4.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.099630</td>
<td style='padding-left:4ex; text-align: right;'>0.2365</td>
<td style='padding-left:4ex; text-align: right;'>-0.5663</td>
<td style='padding-left:4ex; text-align: right;'>0.36700</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Heart:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 5.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.248400</td>
<td style='padding-left:4ex; text-align: right;'>0.2483</td>
<td style='padding-left:4ex; text-align: right;'>-0.7382</td>
<td style='padding-left:4ex; text-align: right;'>0.24150</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Stomach:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 6.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'>-0.209300</td>
<td style='padding-left:4ex; text-align: right;'>0.2403</td>
<td style='padding-left:4ex; text-align: right;'>-0.6835</td>
<td style='padding-left:4ex; text-align: right;'>0.26490</td>
</tr>
<tr>
<td style='text-align: left;'>chronic_disease_v3 --- Depression:None</td>
<td style='padding-left:4ex; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; text-align: right;'> 7.0</td>
<td style='padding-left:4ex; text-align: right;'></td>
<td style='padding-left:4ex; text-align: right;'> 0.180200</td>
<td style='padding-left:4ex; text-align: right;'>0.3284</td>
<td style='padding-left:4ex; text-align: right;'>-0.4677</td>
<td style='padding-left:4ex; text-align: right;'>0.82820</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>chronic_disease_v3 --- Pain:None</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 8.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.009757</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.3640</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.7279</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.70840</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Glutamate-refit-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Glutamate_mod_refit, digits = 1, log = TRUE, main = paste0("% increase/decrease on Glutamate reference value of ", round(ddGlutamate_refit$limits["Glutamate"][2,]), " μmol/g (median)"), nb = 12)
```

## Model - 3rd Pass

The 2nd pass model uses too many degrees of freedom (df) in relation to the size of the data i.e. `14` df should be spent instead of the `27` from the model. This can be seen by conducting a validation and calibration analysis. Below are results from the validation analysis using bootstrapping as the resampling technique. The algorithm can be described as follows [source](https://www.nicholas-ollberding.com/post/an-introduction-to-the-harrell-verse-predictive-modeling-using-the-hmisc-and-rms-packages/):

* Estimate model performance in the original sample of size n 

* Draw a bootstrap sample of the same size n and fit the model to the bootstrap sample 

* Apply the model obtained in the bootstrap sample to the original sample 

* Subtract the accuracy measure found in the bootstrap sample from the accuracy measure in the original sample - this is the estimate of optimism (i.e. overfitting) 

* Repeat the process many times (e.g. 300) and average over the repeats to obtain a final estimate of optimism for each measure 

* Subtract that value from the observed/apparent accuracy measure to get the optimism corrected estimate 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Glutamate_mod_refit_val, digits = 2, caption = "2nd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
2nd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.21</td>
<td style='padding-left:3ex; text-align: center;'>0.3</td>
<td style='padding-left:3ex; text-align: center;'>0.07</td>
<td style='padding-left:3ex; text-align: center;'>0.23</td>
<td style='padding-left:3ex; text-align: center;'>-0.02</td>
<td style='padding-left:3ex; text-align: center;'>292</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.43</td>
<td style='padding-left:3ex; text-align: center;'>0.38</td>
<td style='padding-left:3ex; text-align: center;'>0.51</td>
<td style='padding-left:3ex; text-align: center;'>-0.13</td>
<td style='padding-left:3ex; text-align: center;'>0.56</td>
<td style='padding-left:3ex; text-align: center;'>292</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.37</td>
<td style='padding-left:3ex; text-align: center;'>0.44</td>
<td style='padding-left:3ex; text-align: center;'>0.29</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>0.22</td>
<td style='padding-left:3ex; text-align: center;'>292</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>1.09</td>
<td style='padding-left:3ex; text-align: center;'>-1.09</td>
<td style='padding-left:3ex; text-align: center;'>1.09</td>
<td style='padding-left:3ex; text-align: center;'>292</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.63</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.37</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.63</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>292</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

From this table it can be seen that the optimism statistic which indicates the extent of model overfitting, for a variety of performance metrics has values that are large. Thus overfitting is present in the model. 

By calibrating the predicted values from the model to the observed ones, we also notice a good amount of deviation from the diagonal line (ideal model performance) after correcting for this overfitting or bias. 

```{r}
#| label: fig-Glutamate-refit-cal
#| fig-cap: "Calibration plot for 2nd pass model. Deviation from the diagonal line after correcting for overfitting or bias." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Glutamate_mod_refit_cal)
```

The 2nd pass model also includes the chronic_disease_v3 variable which contains categories with low frequencies in the data. As a result the effect size estimate is accompanied by a very large confidence interval. This renders the estimate as non-trustworthy.  

From these results and also the variable importance plot seen previously as well as the analysis of variance results, it looks like the variables age, bmi, sex and aerobics_activity are most important. These variables can be kept in a new model with less degree of freedom spending i.e. less overfitting the data. 

Hence the model is refitted to the data including various combinations of these 4 covariates, with the chosen model spending just `5` degrees of freedom and having a global p-value equal to `0.0073`.(Note: Situation might change when more data are collected and the model is refit).

The chosen model formula is: 

`log(Glutamate) ~ sex + bmi + age + log(aerobics_activity+1)`

and in expanded form:

```{r}
noquote(reg_f_Glutamate_refit2)
```

The model's reference values can be seen below in the row named `Adjust to`:

```{r}
options(width = 164)
ddGlutamate_refit 
```

### Residuals

```{r}
#| label: fig-Glutamate-refit2-resid-qq 
#| fig-cap: "Normal probabibilty plot comparing quantiles of model residuals and the theoretical normal distribution. Vertical dashed lines indicate the central 95% limits of the normal distribution. Horizontal dashed lines indicate outlier detection thresholds i.e. data outside of these thresholds are deemed outliers. Here the algorithm does not report any weak outliers due to its parameterization i.e. outliers whose deviation from the straight line is not large." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
out_resid_Glutamate_mod_refit2$outliersPlot
```

```{r}
#| label: fig-Glutamate-refit2-resid-yhatVsResid
#| fig-cap: "Plot of predictions vs model residuals. It can be seen that predictions are separated into two groups. This is due to the large influence of the sex covariate (seen in the next section) on the Glutamate concentration levels. Besides this, no other patterns can be observed." 

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(fitted(Glutamate_mod_refit2), resid_Glutamate_mod_refit2, xlab = "Predicted", ylab = "Model Residuals"); abline(h=0)  # yhat vs. r
```

### Variable Importance

```{r}
#| label: fig-Glutamate-refit2-var-importance
#| fig-cap: "Proportion of overall model $R^2$ that is due to each predictor. Large influence of the sex covariate. The rest of the covariates are currently kept in the model as with new data their impact might positively change." 
#| fig-align: left 
#| fig-width: 8   

thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(anova(Glutamate_mod_refit2), what = "proportion R2", main = "", sort = "ascending", margin = "") 
grid(ny = 4, nx = NA, col = "black")
```

### Variable Effects

```{r eval=FALSE}
options(prType="html")
s_Glutamate_mod_refit2
# eval=FALSE after html copy-pasting below
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='8' style='text-align: left;'>
Effects          &emsp;&emsp;Response: <code>log(Glutamate)</code></td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'></th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Low</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>High</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>&Delta;</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Effect</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>S.E.</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Lower 0.95</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: right;'>Upper 0.95</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>bmi</td>
<td style='padding-left:4ex; text-align: right;'>22.8</td>
<td style='padding-left:4ex; text-align: right;'>29.3</td>
<td style='padding-left:4ex; text-align: right;'> 6.5</td>
<td style='padding-left:4ex; text-align: right;'>-0.009689</td>
<td style='padding-left:4ex; text-align: right;'>0.06390</td>
<td style='padding-left:4ex; text-align: right;'>-0.1357</td>
<td style='padding-left:4ex; text-align: right;'> 0.1163</td>
</tr>
<tr>
<td style='text-align: left;'>age</td>
<td style='padding-left:4ex; text-align: right;'>34.0</td>
<td style='padding-left:4ex; text-align: right;'>53.0</td>
<td style='padding-left:4ex; text-align: right;'>19.0</td>
<td style='padding-left:4ex; text-align: right;'> 0.014370</td>
<td style='padding-left:4ex; text-align: right;'>0.07312</td>
<td style='padding-left:4ex; text-align: right;'>-0.1298</td>
<td style='padding-left:4ex; text-align: right;'> 0.1585</td>
</tr>
<tr>
<td style='text-align: left;'>aerobics_activity</td>
<td style='padding-left:4ex; text-align: right;'> 0.0</td>
<td style='padding-left:4ex; text-align: right;'>60.0</td>
<td style='padding-left:4ex; text-align: right;'>60.0</td>
<td style='padding-left:4ex; text-align: right;'> 0.019900</td>
<td style='padding-left:4ex; text-align: right;'>0.08887</td>
<td style='padding-left:4ex; text-align: right;'>-0.1553</td>
<td style='padding-left:4ex; text-align: right;'> 0.1951</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>sex --- Male:Female</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 1.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'> 2.0</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'></td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.380000</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>0.10370</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.5845</td>
<td style='padding-left:4ex; border-bottom: 2px solid grey; text-align: right;'>-0.1756</td>
</tr>
</tbody>
</table>

```{r}
#| label: fig-Glutamate-refit2-var-effects
#| fig-cap: "The further away the central estimate and its corresponding intervals from unity the higher the variable's effect. Confidence intervals are 90%, 95% and 99%, with the dark blue denoting the 90% confidence interval." 
#| fig-width: 12  

thematic::thematic_off() 
plot(s_Glutamate_mod_refit2, digits = 1, log = TRUE, main = paste0("% increase/decrease on Glutamate reference value of ", round(ddGlutamate_refit$limits["Glutamate"][2,]), " μmol/g (median)")) # nb = 4 reduces the spacing between the CIs, looks better without it on the site
```

### Partial Dependence Plots

```{r}
#| label: fig-Glutamate-refit2-var-partial-effects-plot1
#| fig-cap: "Effect of sex. Glutamate concentration levels can be seen to be higher in females than in males." 
#| fig-width: 8  

ggplot(Predict(Glutamate_mod_refit2, sex, fun = exp))
```

```{r}
#| label: fig-Glutamate-refit2-var-partial-effects-plot2
#| fig-cap: "Linear effect of age. Age is seen to increase the levels of Glutamate concentration but at a very slow pace."
#| fig-width: 8 

ggplot(Predict(Glutamate_mod_refit2, age, fun = exp))
```

```{r}
#| label: fig-Glutamate-refit2-var-partial-effects-plot3
#| fig-cap: "No effect of aerobics training on Glutamate concentration levels."
#| fig-width: 8 

ggplot(Predict(Glutamate_mod_refit2, aerobics_activity, fun = exp))
```

```{r}
#| label: fig-Glutamate-refit2-var-partial-effects-plot4
#| fig-cap: "No effect of bmi on levels of Glutamate concentration."
#| fig-width: 8 

ggplot(Predict(Glutamate_mod_refit2, bmi, fun = exp))
```

```{r}
#| label: fig-Glutamate-refit2-var-partial-effects-plot5
#| fig-cap: "Simultaneous effects of age and aerobics_activity. Glutamate concentration levels are seen to increase on average with increasing both age and weekly aerobics training duration."
#| fig-width: 8  
  
# pred_intx1_Glutamate is defined in workspace
bplot(pred_intx1_Glutamate, yhat ~ age + aerobics_activity, lfun = lattice::wireframe, zlab = "Glutamate\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6)
```

```{r}
#| label: fig-Glutamate-refit2-var-partial-effects-plot7
#| fig-cap: "Simultaneous effects of age and bmi. Glutamate concentration levels are seen to increase on average with decreasing bmi and increasing age."
#| fig-width: 8  
  
# pred_intx3_Glutamate is defined in workspace
bplot(pred_intx3_Glutamate, yhat ~ age + bmi, lfun = lattice::wireframe, zlab = "Glutamate\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6)
```

```{r}
#| label: fig-Glutamate-refit2-var-partial-effects-plot8
#| fig-cap: "Simultaneous effects of bmi and aerobics training. Glutamate concentration levels are seen to increase on average with decreasing bmi and increasing duration of aerobics activity."
#| fig-width: 8  
  
# pred_intx6_Glutamate is defined in workspace
bplot(pred_intx6_Glutamate, yhat ~ aerobics_activity + bmi, lfun = lattice::wireframe, zlab = "Glutamate\n",  screen=list(z=120, x=-75), cex.lab = 0.55, cex.adj = 0.6)
```

### Validation & Calibration 

```{r eval=FALSE}
# Run below once and then copy paste below. Once this is done put eval=FALSE for this chunk.
# options(prType="html") 
# options(width = 164) 
rms:::html.validate(Glutamate_mod_refit2_val, digits = 2, caption = "3rd pass model validation")
```

<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em;' >
<thead>
<tr><td colspan='7' style='text-align: left;'>
3rd pass model validation</td></tr>
<tr><th style='border-bottom: 1px solid grey; font-weight: 900; border-top: 2px solid grey; text-align: center;'>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Original<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Training<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Test<br>Sample</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Optimism</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>Corrected<br>Index</th>
<th style='font-weight: 900; border-bottom: 1px solid grey; border-top: 2px solid grey; text-align: center;'>$n$</th>
</tr>
</thead>
<tbody>
<tr>
<td style='text-align: left;'>R-square</td>
<td style='text-align: center;'>0.06</td>
<td style='padding-left:3ex; text-align: center;'>0.08</td>
<td style='padding-left:3ex; text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>0.03</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>MSE</td>
<td style='text-align: center;'>0.51</td>
<td style='padding-left:3ex; text-align: center;'>0.5</td>
<td style='padding-left:3ex; text-align: center;'>0.52</td>
<td style='padding-left:3ex; text-align: center;'>-0.02</td>
<td style='padding-left:3ex; text-align: center;'>0.53</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>$g$</td>
<td style='text-align: center;'>0.19</td>
<td style='padding-left:3ex; text-align: center;'>0.23</td>
<td style='padding-left:3ex; text-align: center;'>0.19</td>
<td style='padding-left:3ex; text-align: center;'>0.04</td>
<td style='padding-left:3ex; text-align: center;'>0.15</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='text-align: left;'>Intercept</td>
<td style='text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0</td>
<td style='padding-left:3ex; text-align: center;'>0.43</td>
<td style='padding-left:3ex; text-align: center;'>-0.43</td>
<td style='padding-left:3ex; text-align: center;'>0.43</td>
<td style='padding-left:3ex; text-align: center;'>300</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: left;'>Slope</td>
<td style='border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>1</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.85</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.15</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>0.85</td>
<td style='padding-left:3ex; border-bottom: 2px solid grey; text-align: center;'>300</td>
</tr>
</tbody>
</table>
<p style="padding-top:2em;">

We note also that the successful number of resamples is 300 (i.e. the number of bootstrap samples that we have chosen to perform the validation). In contrast, the 2nd pass model did not use as many resamples due to divergence or singularity issues which occurred in `r nrow(datGlutamate_refit) - 292` samples, and thus left 292 resamples to use for the validation. These divergence issues were due to reasons such as missing values, categories of the chronic_disease_v3 variable with a low frequency and the complexity of the model.  
In addition this 3rd pass model has used only 211 individuals from the current pool of `r nrow(datGlutamate_refit)` due the many zero or non-detection cases in the data. 

```{r}
#| label: fig-Glutamate-refit2-cal
#| fig-cap: "Calibration plot for 3rd pass model. Deviation from the diagonal line after correcting for overfitting or bias. It can be seen that deviations have been reduced compared to the 2nd pass model." 
#| fig-width: 10
 
thematic::thematic_on(bg = "lavenderblush3", fg = "black", accent = "blue") 
plot(Glutamate_mod_refit2_cal)
```

### Dynamic Reference Intervals 

The following table shows an example of the construction of a 95% reference interval (RI) for each of four subjects with specific covariate values. For the 3rd pass model only age, sex, aerobics_activity and bmi make a difference since the rest of the covariates are not used. 

```{r}
# options(width = 164) # printing all cols of new_dat i.e. even the ones not used in the model was not printing the age column name properly in the html output. So I kept only the columns that the model uses and then the age column name was displayed properly. This was an issue in the web hosting dedicated project:
# /Users/aristidiskoitsanos/Desktop/ari/metabolomics/amino_acid_ref_range_web/amino_acid_ref_range_web.Rproj

# new_dat defined in loaded workspace
dynRI <- new_dat |>
  nest(.by = id) |>
  mutate(preds = map(data, function(df) predict_f(Glutamate_mod_refit2, new_dat = df, conf_type = "mean"))) |>
  unnest_wider(col = preds, names_repair = function(x) {
    nam <- x
    nam[3:4] <- paste0(nam[3:4], "RI")
    nam
  }) |>
  select(-data) |>
  inner_join(new_dat |> select(id, age, sex, bmi, aerobics_activity) |> rename(aerobics = aerobics_activity), by = "id") |>
  mutate(across(where(is.double), ~ round(., 2)))

dynRI  
```

The RI for Glutamate from Mayo Clinic Laboratories for ages above 18 years is less than 45 μmol/g of creatinine.

# Methionine



# Arginine



# Other Section {.unnumbered}


